<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Taproot and MuSig2 recap | Elle Mouton</title><meta name=keywords content><meta name=description content="A recap of the building blocks required for Taproot channels"><meta name=author content><link rel=canonical href=https://www.ellemouton.com/posts/taproot-prelims/><link crossorigin=anonymous href=/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://www.ellemouton.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.ellemouton.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.ellemouton.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.ellemouton.com/apple-touch-icon.png><link rel=mask-icon href=https://www.ellemouton.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-PMLX8P6J9S"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-PMLX8P6J9S',{anonymize_ip:!1})}</script><meta property="og:title" content="Taproot and MuSig2 recap"><meta property="og:description" content="A recap of the building blocks required for Taproot channels"><meta property="og:type" content="article"><meta property="og:url" content="https://www.ellemouton.com/posts/taproot-prelims/"><meta property="og:image" content="https://www.ellemouton.com/taprootPrelims/cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-18T00:00:00+00:00"><meta property="article:modified_time" content="2023-04-18T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.ellemouton.com/taprootPrelims/cover.png"><meta name=twitter:title content="Taproot and MuSig2 recap"><meta name=twitter:description content="A recap of the building blocks required for Taproot channels"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://www.ellemouton.com/posts/"},{"@type":"ListItem","position":3,"name":"Taproot and MuSig2 recap","item":"https://www.ellemouton.com/posts/taproot-prelims/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Taproot and MuSig2 recap","name":"Taproot and MuSig2 recap","description":"A recap of the building blocks required for Taproot channels","keywords":[],"articleBody":"In my last blog post, I promised a follow-up post on the workings of Taproot channels. However, when I started working on it, I realised that it might be a good idea to first dedicate a post to recap the preliminaries that will be required in order to understand the follow-up Taproot channel articles. So here you go!\nOverview This post will cover some basics around Taproot outputs and how to spend them via either the key or script paths. It will also cover the MuSig2 flow between two signing parties. Note that I won’t go into extreme detail for either of these topics. Instead, this post is aimed at refreshing your memory on these topics or giving you enough of an understanding of how Taproot outputs and MuSig2 work so that the follow-up articles are more easily digestible. There are better articles out there for you if you want to get into the nitty-gritty of these topics and of course you can always go check out the BIPs if you are brave: Schnorr signatures, Taproot, Tapscript and MuSig2.\nOk, enough chit-chat. Onto the good stuff!\nA quick note on BIP340 public keys Public keys will mostly be encoded as 32-byte arrays instead of the usual 33-byte compressed public key representation that you might be used to. If the secp256k1 curve is plotted over a non-finite field (as shown below) then you can see that for every x-coordinate, there are two possible y-coordinates. Since the curve is actually over a finite field with an odd order, one y-coordinate for a given x-coordinate will always be even and the other one will be odd. The assumption for 32-byte encoded public keys is that the y-coordinate is always the even one. This means that if you want to create a valid BIP340 signature but your private key, d, produces a public key, P, with an odd y-coordinate, then all you need to do is negate your private key. This will produce public key P’ which has the same x-coordinate as your original public key but with an even y-coordinate. For more information regarding BIP340 public keys and signatures (also known as Schnorr signatures), check out the BIP itself.\nTaproot Outputs A Taproot output shows up in the scriptPubKey section of a transaction (just like all other outputs) and has the following form:\nThe OP_1 indicates that this is a SegWit Version 1 output (a.k.a. Taproot output) and what follows are 32 bytes that represent the output key (see BIP340 public keys above). I will often use Q to refer to this key. To give the full picture, here is a Taproot output in a transaction:\nOk cool. But what exactly is in this output? Is it just like a P2PK output? No. That would be lame. The truth is that this simple-looking output could be a huge variety of different things. It could be a simple single public key (yes, like a P2PK). It could be an n-of-n MuSig2 public key. It could also have a bunch of script branch options, or it could even be a combination of all the above! Let’s break these options down a bit.\nSingle Key or n-of-n MuSig2 outputs If you wanted to just create an output that sends to a single public key, P, then this is easy to do. In this case, your output key, Q, just becomes your key, P, which is often called the internal key.\nTo spend this output, all you need is to provide a BIP340 signature in the witness which you would calculate using the private key, d, used to derive P. See the note explained in the BIP340 Public Keys section about possibly needing to negate your private key first.\nNow, what if you instead wanted to use an n-of-n aggregate MuSig2 public key? Turns out that this will look exactly the same on-chain as for the single key case explained above! All that changes is the steps that you and your fellow signers need to take to set up the aggregate public key and then to calculate the final signature. But once all that is complete, what ends up on-chain looks no different.\nScript Paths Here is where the magic really happens. You can also have the option of spending your Taproot output via a script and each output can have multiple scripts from which it can be spent. Another cool thing is that if you choose to include script paths in your Taproot output, you can still add a regular key path like before. Let’s say, for example, that you want to be able to spend your output at any time, but you also want to add three script paths so that it can also be spent in other scenarios: perhaps after 30 days you want your partner to be able to spend the output. That would be one script path. If you also have two other script paths (perhaps one is a 2-of-3 multi-sig and the other requires a pre-image reveal), then your Taproot output would be constructed as follows:\nLet’s walk through the above diagram a bit:\nFirst, the three scripts (Script A, Script B and Script C) are all put into a Merkle tree as shown bottom right. The root of this Merkle tree is then hashed along with our internal key, P, to get the 32-byte tweak, t. This tweak is converted to its elliptic curve point form by multiplying it with the generator point, G, to get T which is then added to our internal key, P, to get the final output key, Q. I have skipped over some things here such as the details of the script encodings and also how the scripts are hashed in the Merkle tree so check out the relevant BIPs if you are interested.\nAlrighty - our fancy Taproot output has been set up! But now… how do we spend it? There are two ways of spending this transaction: the first is via the internal key, P. We call this a key path spend. The other way is via one of the scripts in the tree. This type of spend is called a script path spend.\nKey Path Spends Spending via the key path is very simple and is similar to spending the output if it was just a normal un-tweaked key as described earlier on. The only difference is that you will need to tweak your private key, d, with the tweak, t. In other words, your new private key becomes d + t which is what you will use to calculate your signature. That’s it! If you spend the output via the key path, there is no need to reveal any of the scripts and so anyone looking at the spend on-chain will have no clue that the output even had the potential to be spent via a script path.\nScript Path Spends To spend via one of the script paths requires a slightly more complicated witness. Let’s say we want to spend via Script B. We will need to do a few things to convince a verifier that we have the right to spend the output:\n We must provide a valid spending script for Script B. We need to prove that Script B is actually embedded in the output.  Step 1 is pretty simple: just provide the valid witness script for Script B along with Script B itself. Step 2 is slightly more involved. To prove that Script B is embedded in Q, we need to give the verifier all the building blocks required in order to actually construct Q. These building blocks are put in what is called the “control block”. The first thing in the control block is the internal key, P. It also contains the Merkle proof that allows the verifier to compute the Merkle tree root. The witness already includes Script B itself (it was required for step 1), so the verifier can compute hB (see the diagram above showing the Merkle tree construction) themselves, and so we just need to provide hA and hC. The validator will use these hashes to calculate the script_root and then hash this along with the internal key, P, in order to arrive at the tweak, t. The validator can then compute the corresponding tweak point, T, add that to the internal key, P, to get the output key, Q. The final thing that the control block must include is a bit indicating if the final Q point has an odd or even y-coordinate so that the validator can check if the Q they computed does have the correct y-coordinate.\nIt is important to note that no knowledge of d (the private key for the internal key, P) was required for spending via Script B (assuming of course that Script B itself does not involve P). Another cool thing is that we did not need to reveal the contents of the other scripts in the tree, only their hashes.\nBIP86 Tweaks There is a clever trick that can be used if you would like to create an output with no script path that allows you to also prove to a third party that there is no script path. All you do is construct Q as if you were constructing an output with script paths but the script root is left empty.\nSpending this output can now only be done via the key spend path using private key d + t. Then, P can be provided to any third parties who want proof that there is no script path. They would use P to compute t and T and then would verify that P + T is equal to the output key, Q. More info about this can be found in BIP86.\nMuSig2 With the Taproot soft fork, bitcoin nodes now have an understanding of BIP340 signatures (or Schnorr signatures). The beauty of these signatures is their linearity: the owner of public key P_1 can create a partial signature, sig_1 for the message msg and the owner of public key P_2 can create sig_2 for the same message. The two parties will then be able to combine their signatures such that sig where sig = sig_1 + sig_2 is a valid signature for the aggregate of their public keys: P = P_1 + P_2.\nThis is really cool because it means that instead of needing to create a long n-of-n multisig script and then needing to pay for the blockchain space to store each of the n signatures, only one signature will be needed and no long script will be required at all. Instead, only a single public key (which is actually an aggregate public key) needs to appear on-chain.\nThe tricky part here is everything that needs to happen off-chain during the setup of this aggregate public key as well as for the creation of the final signature. MuSig2 is the protocol that defines how this should be done. The various steps have been carefully thought through in order to keep the process trust-less and to protect parties from attacks such as key cancellation.\nBIP327 defines the MuSig2 protocol along with a bunch of algorithms that should be used for the various steps of the process. Since the aim of this article is to provide all the building blocks required for understanding Lightning Taproot channels, I will only talk about MuSig2 at an API level using the defined algorithms and will focus more on how it will be used in Lightning. If you would like to dig into it more you can check out the BIP itself. I have also implemented all the MuSig2 methods from scratch here if you are the type of person who prefers looking at code.\nMuSig2 vs n-of-n Multisig An important thing to keep in mind is that with n-of-n multisig outputs, parties can generate their signatures completely independently of the other parties. As long as they have the message to be signed along with their private key, they can create a signature. This signature can then safely be distributed to the other parties and eventually the transaction witness will have all n signatures. In other words: no interaction is required between parties at signing time. With n-of-n MuSig2 this is not the case since there is one public key on-chain and thus one signature needs to be produced. The n parties have to interact with each other in order to produce this final signature.\nExplanation by example Let’s walk through the case where two parties, Alice and Bob, want to set up a 2-of-2 MuSig2 output and then create a signature to spend from it.\nThis first diagram shows the initial state: Alice and Bob both have private keys and the corresponding public keys and currently the two parties have no shared knowledge.\nWhen the two parties decide to construct an output together, they will first need to exchange public keys. Both parties will then use the MuSig2 KeySort algorithm to sort the keys and then the KeyAgg algorithm to aggregate the keys. This will produce the aggregate key, P_agg, which would be the key that would appear in the transaction output.\nOnce Alice and Bob have a shared message that they want to sign (which would most likely be the spending transaction), they can move onto the signing phase.\nStep one of the signing phase involves each party generating nonces. They will each generate a secret nonce, called the secnonce, and from the secnonce the associated public nonce, called the pubnonce, can be determined. Note that each secnonce is actually made up of two private keys and each pubnonce is made up of the two public keys associated with those private keys. The details of why there are two nonces is outside the scope of this post. Alice and Bob will then need to exchange the public nonces and then both parties will use the MuSig2 NonceAgg function to determine the aggregate nonce: aggnonce. Note that this step had nothing to do with the message to be signed meaning that this step can actually take place before the message to be signed is known.\nWhen the public nonces have been exchanged and both parties know the message to be signed then each party can use the MuSig2 Sign function to produce partial signatures.\nThe final step is for the parties to exchange their partial signatures. Each party can then use the MuSig2 PartialSigAgg function to calculate the final signature. This signature will be a valid signature for P_agg over the message, msg.\nIt is important to become familiar with the above MuSig2 flow because it will be used very often in the next few articles. In Taproot channels the funding output of a channel will be a MuSig2 aggregate public key. This means that every commitment transaction created that spends from the funding output will need to go through this signing flow. Since channel states in Lightning are asymmetric, this also means that this flow will need to happen twice per state update: once to sign the local commitment transaction and once to sign the remote one. But more on that in the next blog post :)\nThanks for reading! I hope that was useful. If you think there is anything that could use clarification or that is incorrect then please don’t hesitate to reach out to let me know.\n","wordCount":"2565","inLanguage":"en","image":"https://www.ellemouton.com/taprootPrelims/cover.png","datePublished":"2023-04-18T00:00:00Z","dateModified":"2023-04-18T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.ellemouton.com/posts/taproot-prelims/"},"publisher":{"@type":"Organization","name":"Elle Mouton","logo":{"@type":"ImageObject","url":"https://www.ellemouton.com/favicon.ico"}}}</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:'\\[',right:'\\]',display:!0},{left:'$$',right:'$$',display:!0},{left:'\\(',right:'\\)',display:!1},{left:'$',right:'$',display:!1}],throwOnError:!1})})</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://www.ellemouton.com accesskey=h title="Elle Mouton (Alt + H)">Elle Mouton</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.ellemouton.com/archives title=Archive><span>Archive</span></a></li><li><a href=https://www.ellemouton.com/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Taproot and MuSig2 recap</h1><div class=post-meta><span title="2023-04-18 00:00:00 +0000 UTC">April 18, 2023</span></div></header><figure class=entry-cover><img loading=lazy src=https://www.ellemouton.com/taprootPrelims/cover.png alt></figure><div class=post-content><p>In my <a href=../../posts/open_channel_pre_taproot>last</a> blog post, I promised a follow-up post on the
workings of Taproot channels. However, when I started working on it, I realised
that it might be a good idea to first dedicate a post to recap the preliminaries
that will be required in order to understand the follow-up Taproot channel
articles. So here you go!</p><h1 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h1><p>This post will cover some basics around Taproot outputs and how to spend them
via either the key or script paths. It will also cover the MuSig2 flow between
two signing parties. Note that I won’t go into extreme detail for either of
these topics. Instead, this post is aimed at refreshing your memory on these
topics or giving you enough of an understanding of how Taproot outputs and
MuSig2 work so that the follow-up articles are more easily digestible. There are
better articles out there for you if you want to get into the nitty-gritty of
these topics and of course you can always go check out the BIPs if you are
brave: <a href=https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki>Schnorr signatures</a>, <a href=https://github.com/bitcoin/bips/blob/master/bip-0341.mediawiki>Taproot</a>, <a href=https://github.com/bitcoin/bips/blob/master/bip-0342.mediawiki>Tapscript</a> and
<a href=https://github.com/bitcoin/bips/blob/master/bip-0327.mediawiki>MuSig2</a>.</p><p>Ok, enough chit-chat. Onto the good stuff!</p><h1 id=a-quick-note-on-bip340-public-keys>A quick note on BIP340 public keys<a hidden class=anchor aria-hidden=true href=#a-quick-note-on-bip340-public-keys>#</a></h1><p>Public keys will mostly be encoded as 32-byte arrays instead of the usual
33-byte compressed public key representation that you might be used to. If the
secp256k1 curve is plotted over a non-finite field (as shown below) then you can
see that for every x-coordinate, there are two possible y-coordinates. Since the
curve is actually over a finite field with an odd order, one y-coordinate for a
given x-coordinate will always be even and the other one will be odd. The
assumption for 32-byte encoded public keys is that the y-coordinate is always
the even one. This means that if you want to create a valid BIP340 signature but
your private key, <code>d</code>, produces a public key, <code>P</code>, with an odd y-coordinate,
then all you need to do is <em>negate</em> your private key. This will produce public
key <code>P’</code> which has the same x-coordinate as your original public key but with an
even y-coordinate. For more information regarding BIP340 public keys and
signatures (also known as Schnorr signatures), check out the <a href=https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki>BIP</a>
itself.</p><p><img loading=lazy src=/taprootPrelims/curve.png#center alt></p><h1 id=taproot-outputs>Taproot Outputs<a hidden class=anchor aria-hidden=true href=#taproot-outputs>#</a></h1><p>A Taproot output shows up in the <code>scriptPubKey</code> section of a transaction (just
like all other outputs) and has the following form:</p><p><img loading=lazy src=/taprootPrelims/tr-output.png#center alt></p><p>The <code>OP_1</code> indicates that this is a SegWit Version 1 output (a.k.a. Taproot
output) and what follows are 32 bytes that represent the output key (see
<a href=#a-quick-note-on-bip340-public-keys>BIP340 public keys</a> above). I will often
use <code>Q</code> to refer to this key. To give the full picture, here is a Taproot
output in a transaction:</p><p><img loading=lazy src=/taprootPrelims/tr-output-in-tx.png#center alt></p><p>Ok cool. But what exactly is in this output? Is it just like a P2PK output? No.
That would be lame. The truth is that this simple-looking output could be a huge
variety of different things. It could be a simple single public key (yes, like
a P2PK). It could be an n-of-n MuSig2 public key. It could also have a bunch of
script branch options, or it could even be a combination of all the above! Let’s
break these options down a bit.</p><h2 id=single-key-or-n-of-n-musig2-outputs>Single Key or n-of-n MuSig2 outputs<a hidden class=anchor aria-hidden=true href=#single-key-or-n-of-n-musig2-outputs>#</a></h2><p>If you wanted to just create an output that sends to a single public key, <code>P</code>,
then this is easy to do. In this case, your output key, <code>Q</code>, just becomes your
key, <code>P</code>, which is often called the <em>internal key</em>.</p><p><img loading=lazy src=/taprootPrelims/tr-single-key.png#center alt></p><p>To spend this output, all you need is to provide a BIP340 signature in the
witness which you would calculate using the private key, <code>d</code>, used to derive
<code>P</code>. See the note explained in the <a href=#a-quick-note-on-bip340-public-keys>BIP340 Public
Keys</a> section about possibly needing to
negate your private key first.</p><p><img loading=lazy src=/taprootPrelims/tr-single-key-spend.png#center alt></p><p>Now, what if you instead wanted to use an n-of-n aggregate MuSig2 public key?
Turns out that this will look <em>exactly</em> the same on-chain as for the single key
case explained above! All that changes is the steps that you and your fellow
signers need to take to set up the aggregate public key and then to calculate
the final signature. But once all that is complete, what ends up on-chain looks
no different.</p><p><img loading=lazy src=/taprootPrelims/musig-output.png#center alt></p><h2 id=script-paths>Script Paths<a hidden class=anchor aria-hidden=true href=#script-paths>#</a></h2><p>Here is where the magic really happens. You can also have the option of
spending your Taproot output via a script <em>and</em> each output can have multiple
scripts from which it can be spent. Another cool thing is that if you choose to
include script paths in your Taproot output, you can still add a regular key
path like before. Let’s say, for example, that you want to be able to spend your
output at any time, but you also want to add three script paths so that it can
also be spent in other scenarios: perhaps after 30 days you want your partner to
be able to spend the output. That would be one script path. If you also have two
other script paths (perhaps one is a 2-of-3 multi-sig and the other requires a
pre-image reveal), then your Taproot output would be constructed as follows:</p><p><img loading=lazy src=/taprootPrelims/tr-whole-thing.png#center alt></p><p>Let’s walk through the above diagram a bit:</p><p>First, the three scripts (<code>Script A</code>, <code>Script B</code> and <code>Script C</code>) are all put
into a <a href=https://en.wikipedia.org/wiki/Merkle_tree>Merkle tree</a> as shown bottom right. The root of this Merkle tree
is then hashed along with our internal key, <code>P</code>, to get the 32-byte tweak, <code>t</code>.
This tweak is converted to its elliptic curve point form by multiplying it with
the generator point, <code>G</code>, to get <code>T</code> which is then added to our internal key,
<code>P</code>, to get the final output key, <code>Q</code>. I have skipped over some things here such
as the details of the script encodings and also how the scripts are hashed in
the Merkle tree so check out the relevant BIPs if you are interested.</p><p>Alrighty - our fancy Taproot output has been set up! But now… how do we spend
it? There are two ways of spending this transaction: the first is via the
internal key, <code>P</code>. We call this a <a href=#key-path-spends><em>key path spend</em></a>. The
other way is via one of the scripts in the tree. This type of spend is called a
<a href=#script-path-spends><em>script path spend</em></a>.</p><h3 id=key-path-spends>Key Path Spends<a hidden class=anchor aria-hidden=true href=#key-path-spends>#</a></h3><p>Spending via the key path is very simple and is similar to spending the output
if it was just a normal un-tweaked key as described <a href=#single-key-or-n-of-n-musig2-outputs>earlier
on</a>. The only difference is that you will
need to tweak your private key, <code>d</code>, with the tweak, <code>t</code>. In other words, your
new private key becomes <code>d + t</code> which is what you will use to calculate your
signature. That’s it! If you spend the output via the key path, there is no
need to reveal any of the scripts and so anyone looking at the spend on-chain
will have no clue that the output even had the potential to be spent via a
script path.</p><p><img loading=lazy src=/taprootPrelims/tr-tweaked-pk.png#center alt></p><h3 id=script-path-spends>Script Path Spends<a hidden class=anchor aria-hidden=true href=#script-path-spends>#</a></h3><p>To spend via one of the script paths requires a slightly more complicated
witness. Let’s say we want to spend via <code>Script B</code>. We will need to do a few
things to convince a verifier that we have the right to spend the output:</p><ol><li>We must provide a valid spending script for <code>Script B</code>.</li><li>We need to prove that <code>Script B</code> is actually embedded in the output.</li></ol><p>Step 1 is pretty simple: just provide the valid witness script for <code>Script B</code>
along with <code>Script B</code> itself. Step 2 is slightly more involved. To prove that
<code>Script B</code> is embedded in <code>Q</code>, we need to give the verifier all the building
blocks required in order to actually construct <code>Q</code>. These building blocks are
put in what is called the “control block”. The first thing in the control block
is the internal key, <code>P</code>. It also contains the Merkle proof that allows the
verifier to compute the Merkle tree root. The witness already includes
<code>Script B</code> itself (it was required for step 1), so the verifier can compute
<code>hB</code> (see the diagram above showing the Merkle tree construction) themselves,
and so we just need to provide <code>hA</code> and <code>hC</code>. The validator will use these
hashes to calculate the <code>script_root</code> and then hash this along with the
internal key, <code>P</code>, in order to arrive at the tweak, <code>t</code>. The validator can then
compute the corresponding tweak point, <code>T</code>, add that to the internal key, <code>P</code>,
to get the output key, <code>Q</code>. The final thing that the control block must include
is a bit indicating if the final <code>Q</code> point has an odd or even y-coordinate so
that the validator can check if the <code>Q</code> they computed does have the correct
y-coordinate.</p><p><img loading=lazy src=/taprootPrelims/script-spending-witness.png#center alt></p><p>It is important to note that no knowledge of <code>d</code> (the private key for the
internal key, <code>P</code>) was required for spending via <code>Script B</code> (assuming of course
that <code>Script B</code> itself does not involve <code>P</code>). Another cool thing is that we did
not need to reveal the contents of the other scripts in the tree, only their
hashes.</p><h3 id=bip86-tweaks>BIP86 Tweaks<a hidden class=anchor aria-hidden=true href=#bip86-tweaks>#</a></h3><p>There is a clever trick that can be used if you would like to create an output
with no script path that allows you to also prove to a third party that there
is no script path. All you do is construct <code>Q</code> as if you were constructing an
output with script paths <em>but</em> the script root is left empty.</p><p><img loading=lazy src=/taprootPrelims/bip86-tweak.png#center alt></p><p>Spending this output can now only be done via the key spend path using private
key <code>d + t</code>. Then, <code>P</code> can be provided to any third parties who want proof that
there is no script path. They would use <code>P</code> to compute <code>t</code> and <code>T</code> and then
would verify that <code>P + T</code> is equal to the output key, <code>Q</code>. More info about this
can be found in <a href=https://github.com/bitcoin/bips/blob/master/bip-0086.mediawiki#address-derivation>BIP86</a>.</p><h1 id=musig2>MuSig2<a hidden class=anchor aria-hidden=true href=#musig2>#</a></h1><p>With the Taproot soft fork, bitcoin nodes now have an understanding of BIP340
signatures (or Schnorr signatures). The beauty of these signatures is their
linearity: the owner of public key <code>P_1</code> can create a partial signature,
<code>sig_1</code> for the message <code>msg</code> and the owner of public key <code>P_2</code> can create
<code>sig_2</code> for the same message. The two parties will then be able to combine their
signatures such that <code>sig</code> where <code>sig = sig_1 + sig_2</code> is a valid signature for
the aggregate of their public keys: <code>P = P_1 + P_2</code>.</p><p>This is really cool because it means that instead of needing to create a long
n-of-n multisig script and then needing to pay for the blockchain space to store
each of the <code>n</code> signatures, only one signature will be needed and no long script
will be required at all. Instead, only a single public key (which is actually an
<em>aggregate</em> public key) needs to appear on-chain.</p><p>The tricky part here is everything that needs to happen <em>off-chain</em> during the
setup of this aggregate public key as well as for the creation of the final
signature. <a href=https://github.com/bitcoin/bips/blob/master/bip-0327.mediawiki>MuSig2</a> is the protocol that defines how this should be
done. The various steps have been carefully thought through in order to keep
the process trust-less and to protect parties from attacks such as key
cancellation.</p><p><a href=https://github.com/bitcoin/bips/blob/master/bip-0327.mediawiki>BIP327</a> defines the MuSig2 protocol along with a bunch of algorithms
that should be used for the various steps of the process. Since the aim of this
article is to provide all the building blocks required for understanding
Lightning Taproot channels, I will only talk about MuSig2 at an API level using
the defined algorithms and will focus more on how it will be used in Lightning.
If you would like to dig into it more you can check out the BIP itself. I have
also implemented all the MuSig2 methods from scratch <a href=https://github.com/ellemouton/schnorr/tree/master/musig2>here</a> if you
are the type of person who prefers looking at code.</p><h2 id=musig2-vs-n-of-n-multisig>MuSig2 vs n-of-n Multisig<a hidden class=anchor aria-hidden=true href=#musig2-vs-n-of-n-multisig>#</a></h2><p>An important thing to keep in mind is that with n-of-n multisig outputs, parties
can generate their signatures completely independently of the other parties. As
long as they have the message to be signed along with their private key, they
can create a signature. This signature can then safely be distributed to the
other parties and eventually the transaction witness will have all <code>n</code>
signatures. In other words: no interaction is required between parties at
signing time. With n-of-n <em>MuSig2</em> this is not the case since there is one
public key on-chain and thus one signature needs to be produced. The <code>n</code> parties
have to interact with each other in order to produce this final signature.</p><h2 id=explanation-by-example>Explanation by example<a hidden class=anchor aria-hidden=true href=#explanation-by-example>#</a></h2><p>Let’s walk through the case where two parties, Alice and Bob, want to set up a
2-of-2 MuSig2 output and then create a signature to spend from it.</p><p>This first diagram shows the initial state: Alice and Bob both have private keys
and the corresponding public keys and currently the two parties have no shared
knowledge.</p><p><img loading=lazy src=/taprootPrelims/musig-1.png#center alt></p><p>When the two parties decide to construct an output together, they will first
need to exchange public keys. Both parties will then use the MuSig2 <code>KeySort</code>
algorithm to sort the keys and then the <code>KeyAgg</code> algorithm to aggregate the
keys. This will produce the aggregate key, <code>P_agg</code>, which would be the key that
would appear in the transaction output.</p><p><img loading=lazy src=/taprootPrelims/musig-2.png#center alt></p><p>Once Alice and Bob have a shared message that they want to sign (which would
most likely be the spending transaction), they can move onto the signing phase.</p><p><img loading=lazy src=/taprootPrelims/musig-3.png#center alt></p><p>Step one of the signing phase involves each party generating nonces. They will
each generate a secret nonce, called the <code>secnonce</code>, and from the <code>secnonce</code> the
associated public nonce, called the <code>pubnonce</code>, can be determined. Note that
each <code>secnonce</code> is actually made up of two private keys and each <code>pubnonce</code> is
made up of the two public keys associated with those private keys. The details
of why there are two nonces is outside the scope of this post. Alice and Bob
will then need to exchange the public nonces and then both parties will use the
MuSig2 <code>NonceAgg</code> function to determine the aggregate nonce: <code>aggnonce</code>. Note
that this step had nothing to do with the message to be signed meaning that this
step can actually take place before the message to be signed is known.</p><p><img loading=lazy src=/taprootPrelims/musig-4.png#center alt></p><p>When the public nonces have been exchanged and both parties know the message to
be signed then each party can use the MuSig2 <code>Sign</code> function to produce partial
signatures.</p><p><img loading=lazy src=/taprootPrelims/musig-5.png#center alt></p><p>The final step is for the parties to exchange their partial signatures. Each
party can then use the MuSig2 <code>PartialSigAgg</code> function to calculate the final
signature. This signature will be a valid signature for <code>P_agg</code> over the
message, <code>msg</code>.</p><p><img loading=lazy src=/taprootPrelims/musig-6.png#center alt></p><p>It is important to become familiar with the above MuSig2 flow because it will be
used very often in the next few articles. In Taproot channels the funding output
of a channel will be a MuSig2 aggregate public key. This means that every
commitment transaction created that spends from the funding output will need to
go through this signing flow. Since channel states in Lightning are asymmetric,
this also means that this flow will need to happen twice per state update: once
to sign the local commitment transaction and once to sign the remote one. But
more on that in the next blog post :)</p><p>Thanks for reading! I hope that was useful. If you think there is anything that
could use clarification or that is incorrect then please don’t hesitate to reach
out to let me know.</p></div><footer class=post-footer><ul class=post-tags></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Taproot and MuSig2 recap on twitter" href="https://twitter.com/intent/tweet/?text=Taproot%20and%20MuSig2%20recap&url=https%3a%2f%2fwww.ellemouton.com%2fposts%2ftaproot-prelims%2f&hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Taproot and MuSig2 recap on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.ellemouton.com%2fposts%2ftaproot-prelims%2f&title=Taproot%20and%20MuSig2%20recap&summary=Taproot%20and%20MuSig2%20recap&source=https%3a%2f%2fwww.ellemouton.com%2fposts%2ftaproot-prelims%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Taproot and MuSig2 recap on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.ellemouton.com%2fposts%2ftaproot-prelims%2f&title=Taproot%20and%20MuSig2%20recap"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Taproot and MuSig2 recap on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.ellemouton.com%2fposts%2ftaproot-prelims%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Taproot and MuSig2 recap on whatsapp" href="https://api.whatsapp.com/send?text=Taproot%20and%20MuSig2%20recap%20-%20https%3a%2f%2fwww.ellemouton.com%2fposts%2ftaproot-prelims%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Taproot and MuSig2 recap on telegram" href="https://telegram.me/share/url?text=Taproot%20and%20MuSig2%20recap&url=https%3a%2f%2fwww.ellemouton.com%2fposts%2ftaproot-prelims%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer><script src=https://utteranc.es/client.js repo=ellemouton/website issue-term=pathname theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.ellemouton.com>Elle Mouton</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>