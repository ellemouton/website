<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Lightning Network Onion Routing: Preliminaries | Elle Mouton</title><meta name=keywords content><meta name=description content="This post covers the basics of choosing a path and packaging information for each hop on the path"><meta name=author content="map[email:elle.mouton@gmail.com name:Elle Mouton]"><link rel=canonical href=https://www.ellemouton.com/posts/onion-routing-prelims/><link crossorigin=anonymous href=/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://www.ellemouton.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.ellemouton.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.ellemouton.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.ellemouton.com/apple-touch-icon.png><link rel=mask-icon href=https://www.ellemouton.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-PMLX8P6J9S"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-PMLX8P6J9S',{anonymize_ip:!1})}</script><meta property="og:title" content="Lightning Network Onion Routing: Preliminaries"><meta property="og:description" content="This post covers the basics of choosing a path and packaging information for each hop on the path"><meta property="og:type" content="article"><meta property="og:url" content="https://www.ellemouton.com/posts/onion-routing-prelims/"><meta property="og:image" content="https://www.ellemouton.com/onion_prelims/cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-25T00:00:00+00:00"><meta property="article:modified_time" content="2024-03-25T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.ellemouton.com/onion_prelims/cover.png"><meta name=twitter:title content="Lightning Network Onion Routing: Preliminaries"><meta name=twitter:description content="This post covers the basics of choosing a path and packaging information for each hop on the path"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://www.ellemouton.com/posts/"},{"@type":"ListItem","position":3,"name":"Lightning Network Onion Routing: Preliminaries","item":"https://www.ellemouton.com/posts/onion-routing-prelims/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Lightning Network Onion Routing: Preliminaries","name":"Lightning Network Onion Routing: Preliminaries","description":"This post covers the basics of choosing a path and packaging information for each hop on the path","keywords":[],"articleBody":"Overview In this post will cover the preliminaries you need to be aware of for pathfinding, and it also sets the scene for Sphinx packet construction which will be covered in a follow-up post. Specifically, we answer some basic questions such as: “For a node making a payment, how do I find a path to the destination node? And how do I communicate to each node on the path what it should do?”\nBy the end of this post, you should understand what information the sender needs in order to construct a path, what information it must communicate to each node on that path and how it passes that information on to each node. For this last point, this post covers an initial naive approach that will set you up for understanding why Sphinx packet construction is necessary.\nAs per usual, I’ll use a long-running example throughout the post.\nSetting the scene Meet Alice and Dave (don’t stress, Bob will appear later but today is Dave’s time to shine) they are two nodes on the Lightning Network.\nAlice wants to pay Dave for a coffee and so Dave generates an invoice and shows it to Alice using a QR code.\nAs you can see, the invoice has some useful information:\n amount: the number of milli-satoshis that Dave expects to receive before giving Alice the coffee. payment_hash: this is the hash that will be used in the HTLC transactions. memo: a nice little human-readable description of what the payment is for. payee_pub_key: this is Dave’s public key that would have been announced in his node_announcement. min_final_cltv_expiry_delta: This defines the amount of time (or number of blocks rather) that Dave wants to safety be able to claim the HTLC for this payment before it times out. This will become more clear later on.  Finding a path With invoice in hand, Alice is one step closer to paying Dave. The payee_pub_key in the invoice tells Alice where to find Dave in the network. Remember that Alice will have collected a range of node and channel announcements in order to construct a local graph of the network so now all she has to do is find Dave in that network and then find paths (via channels) that lead to Dave’s node.\nThe diagram above shows Alice’s view of the network along with Dave’s position within the network. Apart from the node and channel announcements that Alice has received, she would also have received channel_update messages from all these nodes for each of the channels that they own. The channel_update messages contain information about the relay policy that that node will enforce if other nodes wish to route payments over its channel. Each channel_update contains the following info:\n channel_ID: This identifies the channel that the update is referring to. fee_base_msat: This is the fee (in milli-satoshis) that the node will charge for routing any payment regardless of the size of the payment. fee_proportional_millionths: Also known as the “fee rate”, this is the number of satoshis that will be charged for every million satoshis routed across that channel. cltv_expiry_delta: This is the delta between the incoming HTLC’s CLTV and outgoing HTLC’s CLTV that the node requires (more on this later).  Here is the updated version of Alice’s graph view showing the channel_update information she has about each channel in her graph.\nIf we narrow down on the current goal which is to pay Dave, we can simplify this diagram quite a bit to only show the relevant data. We only care about the channels that are on a potential path between Alice and Dave and we only care about the channel_update from nodes where we will potentially be sending across their channel in the outbound direction. For example: Both Bob and Charlie have advertised channel_updates referring to channel BC, but because Alice only cares about the direction from Bob to Charlie, she only needs to look at the information from Bob’s channel_update for the channel since it always refers to the outgoing direction.\nThe above diagram shows the two potential paths from Alice to Dave:\n1. Alice - Bob - Charlie - Dave via channels AB, BC and CD 2. Alice - Eve - Charlie - Dave via channels AE, EC and CD If Alice is smart, she will pick the path which will cost her the least amount of fees. Let’s do some calculations to determine which one would be more cost-effective for her.\nPath 1 To work out the total fees for a path, we have to work backwards from the destination.\n We know that Dave should be paid 4999999 msats (he said so in his invoice) which means that this is the number of sats that will be routed through Charlie. So the amount of fees to pay to Charlie can be calculated as follows:   = Charlie’s Base Fee + Charlie’s proportional fee in parts per million/1000000 * (The amount routed through Charlie) = 100 + 1000/1000000(4999999) = 100 + 4999999000/1000000 = 100 + 4999.999 = 5099.99 ~ 5100 So the total number of sats that should be sent to Charlie is:\n = 4999999 + 5100 = 5005099 = 5005099 msats  5005099 msats need to be routed through Bob, so the fee we would need to pay to Bob is:   = 200 + 2000/1000000(5005099) = 200 + 2/1000(5005099) = 10211 So the total number of sats to send to Bob is:\n = 5005099 + 10211 = 5015310 This means that Alice will pay the following amount in fees for the payment:\n = 5015310 - 4999999 = 15311 msats Path 2 Alice will do the same type of calculation for the path 2.\n Charlie’s step will be the same: He must be paid a total of 5005099 msats. Then we work out what we would need to pay Eve:   = 300 + 3000/1000000(5005099) = 300 + 3/1000(5005099) = 15316 msats So the total number of sats to send to Eve is:\n = 5005099 + 15316 = 5020415 msats Ie, the total that Alice will pay in fees is:\n5020415-4999999 = 20416 msats Aaaand the winner is: Path 1! Now we only need care about the following info:\nHop Payloads Alice now has enough information to know what she wants to communicate to each hop along the path.\nAlice wants Dave to receive an update_add_htlc from Charlie on the CD channel. The payment_hash should match the one specified in the invoice received from Dave. The amount_msat will be 4999999 as specified in the invoice. Alice then also checks the current block height (height 1001) and uses that along with the min_final_cltv_expiry_delta(9) in the invoice to calculate that the outgoing CLTV value on the HTLC should be 1010.\nUsing the fee calculation we did earlier for this path, Alice can also determine what the update_add_htlcs should look like for the Bob-to-Charlie and Alice-to-Bob steps. If the fact that the CLTVs for each HTLC increases from right to left is confusing, check out this quick CLTV delta explainer.\nThe only part of the puzzle that is missing here is: How does Alice tell Charlie what to forward to Dave if she is only connected to Bob? This is where the onion_routing_packet field in update_add_htlc comes in. Alice packages up what she wants to tell each node and essentially then wraps it with the payload for the previous node. The diagram below should make this more clear:\nSo Bob gets the information for him from Alice but also a packet that he should forward to Charlie. Charlie gets this packet and reads the data meant for him and sees that there is also a payload that he should forward on to Dave. Dave gets his payload and sees that he is the final node in the path. At this point, Dave will check if he has the pre-image for the incoming payment hash. Note that this is where the idea of the “onion” comes in: each hop gets a packet that they must “peel” like an onion.\nNaive Onion Packet Construction Let’s take a moment to imagine what the actual onion packets will look like. Heads up here that this is not the final construction. I will build up a possible structure here, and then I will explain why this is not the way things actually look. The details of how this is actually done will be covered in the next post.\nOk so Alice knows what she wants to tell each of the hops. This is called the “hop payload”. She puts together the following packet for Bob:\nThe packet has the following components:\n 1 byte packet version byte Alice’s public key The payloads for each hop. Note that each payload also has an HMAC which that hop will need to pass the packet on to the next hop (this will be more clear in a moment). Finally, an HMAC produced by Alice using her key over the packet’s hop payloads.  (What is an HMAC? I’ll explain this better in the next post but for now, just think of it as a digital signature used to verify the integrity of a payload)\nBob will receive this packet and will do the following:\n He will check that the HMAC is valid (in other words he checks that the packet has not been tampered with). He will read the payload meant for him along with the HMAC. He will reconstruct the packet that should be passed on to Charlie. He will append the HMAC given to him by Alice for this packet since he cannot produce this HMAC himself.  Charlie will receive this packet and do the following:\n He will check that the HMAC is valid. He will read the payload meant for him along with the HMAC He will reconstruct the packet that should be passed on to Dave:  Dave will receive this packet and do the following:\n He will check that the HMAC is valid. He will read the payload meant for him along with the HMAC. The HMAC he receives will be an empty byte array. This indicates to Dave that he is the final hop.  Ok so what are some issues with this construction?\n Each hop can read the payload for each hop that follows. This leaks who the receiver is. Each hop is told Alice’s public key, and so they all know who is sending to the receiver. Even if the individual payloads were encrypted, the packet gets smaller and smaller further along the path and so intermediary nodes would be able to guess how far they are away from the final hop based on the packet length.  In other words: privacy = bad. We can’t have that. Enter Sphinx packet construction! With Sphinx packet construction:\n Each payload is encrypted so that it can only be decrypted by the node it was meant for. The sender does not share their real public key but instead use a different ephemeral key for each hop. The packet size remains constant at each hop.  I’ll see you in the next post for all the details on this!\nA note on CLTV Deltas To understand why nodes advertise a CLTV delta and how this is used by the sender of a payment to determine which CLTV to communicate to each hop, let’s take a step back and just look at the structure of an HTLC:\nThe diagram above shows the HTLC between Charlie and Dave (the last node on the path). An HTLC has two possible spending paths: The pre-image path which will pay the funds to Dave if he is able to produce the pre-image corresponding to the payment hash. The other path is the timeout path which will pay the funds back to Charlie. This timeout path is only spendable after the block height defined by CLTV A. Let’s assume that the current block height is 1001. If CLTV A is 1002, then there is a real chance that just as Dave is about to reveal the pre-image to Charlie, block 1002 gets mined and Charlie quickly goes ahead and broadcasts the transaction and spends the timeout path before Dave is able to sweep the pre-image path. To prevent this race, Dave will want some time where he can confidently spend the pre-image path if he needs to before the timelock path becomes spendable. He communicates his desired buffer, 9 blocks,\nusing the min_final_cltv_expiry_delta field of the invoice that he sends to Alice. Alice then knows that if she were to send the payment right now while the block height is 1001, that Dave will fail any incoming HTLC with a CLTV A smaller than 1010 (1001 + 9).\nNow, let’s zoom out a bit more and include the HTLC between Bob and Charlie. We want to now figure out what an appropriate value would be for the CLTV on the HTLC between Bob and Charlie, CLTV B.\nLet’s assume that Dave waits until the very last minute to reveal the pre-image to Charlie. In other words, he waits until just before block 1010 is mined. Charlie now needs to turn around and present this pre-image to Bob. In the case that Bob goes on-chain with the HTLC, Charlie requires some time where he can spend the pre-image path without worrying about Bob being able to spend the timeout path. This buffer that Charlie requires between receiving the pre-image from Dave and being able to spend the pre-image path safely from the HTLC with Bob is Charlie’s CLTV delta. He will advertise this value in his channel_update and he expects Alice to use that value when constructing her payment path. If a payment comes through to Bob and the difference between CLTV_B and CLTV_A value is less than the delta that he advertised, he will fail the payment. He requires that CLTV_B be equal to at least CLTV_A plus his advertised CLTV delta.\nBonus Section: Hop Hints This post is a good place to quickly cover what you need to know about hop hints and how they affect the process of path finding.\nIf we go back to the image of Alice’s view of the graph based on the channel_announcements that she has received, there is a chance that Alice actually doesn’t know about the channel between Charlie and Dave (Channel CD). This is because it might be a private channel that Charlie and Dave chose not to announce to the network.\nIn this case, Alice will not be able to find a path to Dave’s node unless he provides her with more information in the invoice he sends her. The extra information that Dave may provide is made up of one or more “Hop Hints”. These hints need to make up for any information that Alice would have received from a channel_announcement and channel_update for the channel. This information includes Charlie’s public key, the SCID of the channel and then all the routing policy rules for the channel.\nThe rest of the path finding process is the same :)\nConclusion Alrighty! I hope things are making a bit more sense now and that you understand both how a sender goes about finding a path to a destination node along with what the sender needs to communicate to each node on the path. In the next post we will take a deep dive into exactly how the onion packet carrying the hop payloads is constructed to maintain maximum privacy.\n","wordCount":"2563","inLanguage":"en","image":"https://www.ellemouton.com/onion_prelims/cover.png","datePublished":"2024-03-25T00:00:00Z","dateModified":"2024-03-25T00:00:00Z","author":{"@type":"Person","name":{"email":"elle.mouton@gmail.com","name":"Elle Mouton"}},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.ellemouton.com/posts/onion-routing-prelims/"},"publisher":{"@type":"Organization","name":"Elle Mouton","logo":{"@type":"ImageObject","url":"https://www.ellemouton.com/favicon.ico"}}}</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:'\\[',right:'\\]',display:!0},{left:'$$',right:'$$',display:!0},{left:'\\(',right:'\\)',display:!1},{left:'$',right:'$',display:!1}],throwOnError:!1})})</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://www.ellemouton.com accesskey=h title="Elle Mouton (Alt + H)">Elle Mouton</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.ellemouton.com/archives title=Archive><span>Archive</span></a></li><li><a href=https://www.ellemouton.com/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Lightning Network Onion Routing: Preliminaries</h1><div class=post-meta><span title="2024-03-25 00:00:00 +0000 UTC">March 25, 2024</span>&nbsp;·&nbsp;map[email:elle.mouton@gmail.com name:Elle Mouton]</div></header><figure class=entry-cover><img loading=lazy src=https://www.ellemouton.com/onion_prelims/cover.png alt></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#overview aria-label=Overview>Overview</a></li><li><a href=#setting-the-scene aria-label="Setting the scene">Setting the scene</a></li><li><a href=#finding-a-path aria-label="Finding a path">Finding a path</a><ul><ul><li><a href=#path-1 aria-label="Path 1">Path 1</a></li><li><a href=#path-2 aria-label="Path 2">Path 2</a></li></ul></ul></li><li><a href=#hop-payloads aria-label="Hop Payloads">Hop Payloads</a></li><li><a href=#naive-onion-packet-construction aria-label="Naive Onion Packet Construction">Naive Onion Packet Construction</a></li><li><a href=#a-note-on-cltv-deltas aria-label="A note on CLTV Deltas">A note on CLTV Deltas</a></li><li><a href=#bonus-section-hop-hints aria-label="Bonus Section: Hop Hints">Bonus Section: Hop Hints</a></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li></ul></div></details></div><div class=post-content><h1 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h1><p>In this post will cover the preliminaries you need to be aware of for
pathfinding, and it also sets the scene for Sphinx packet construction which
will be covered in a <a href=../../posts/sphinx>follow-up post</a>. Specifically, we answer some
basic questions such as: &ldquo;For a node making a payment, how do I find a path to
the destination node? And how do I communicate to each node on the path what it
should do?&rdquo;</p><p>By the end of this post, you should understand what information the sender
needs in order to construct a path, what information it must communicate to each
node on that path and how it passes that information on to each node. For this
last point, this post covers an initial naive approach that will set you up for
understanding why Sphinx packet construction is necessary.</p><p>As per usual, I&rsquo;ll use a long-running example throughout the post.</p><h1 id=setting-the-scene>Setting the scene<a hidden class=anchor aria-hidden=true href=#setting-the-scene>#</a></h1><p>Meet Alice and Dave (don’t stress, Bob will appear later but today is Dave’s
time to shine) they are two nodes on the Lightning Network.</p><p><img loading=lazy src=/onion_prelims/1-alice-and-dave.png#center alt></p><p>Alice wants to pay Dave for a coffee and so Dave generates an invoice and shows
it to Alice using a QR code.</p><p><img loading=lazy src=/onion_prelims/2-invoice.png#center alt></p><p>As you can see, the invoice has some useful information:</p><ul><li><code>amount</code>: the number of milli-satoshis that Dave expects to receive before
giving Alice the coffee.</li><li><code>payment_hash</code>: this is the hash that will be used in the HTLC transactions.</li><li><code>memo</code>: a nice little human-readable description of what the payment is for.</li><li><code>payee_pub_key</code>: this is Dave’s public key that would have been announced in
his <code>node_announcement</code>.</li><li><code>min_final_cltv_expiry_delta</code>: This defines the amount of time (or number of
blocks rather) that Dave wants to safety be able to claim the HTLC for this
payment before it times out. This will become more clear later on.</li></ul><h1 id=finding-a-path>Finding a path<a hidden class=anchor aria-hidden=true href=#finding-a-path>#</a></h1><p>With invoice in hand, Alice is one step closer to paying Dave. The
<code>payee_pub_key</code> in the invoice tells Alice where to find Dave in the network.
<a href=../../posts/open_channel_pre_taproot>Remember</a> that Alice will have collected a range of node and
channel announcements in order to construct a local graph of the network so now
all she has to do is find Dave in that network and then find paths (via
channels) that lead to Dave’s node.</p><p><img loading=lazy src=/onion_prelims/3-graph.png#center alt></p><p>The diagram above shows Alice’s view of the network along with Dave’s position
within the network. Apart from the node and channel announcements that Alice
has received, she would also have received <code>channel_update</code> messages from all
these nodes for each of the channels that they own. The <code>channel_update</code>
messages contain information about the relay policy that that node will enforce
if other nodes wish to route payments over its channel. Each <code>channel_update</code>
contains the following info:</p><ul><li><code>channel_ID</code>: This identifies the channel that the update is referring to.</li><li><code>fee_base_msat</code>: This is the fee (in milli-satoshis) that the node will
charge for routing any payment regardless of the size of the payment.</li><li><code>fee_proportional_millionths</code>: Also known as the “fee rate”, this is the
number of satoshis that will be charged for every million satoshis routed
across that channel.</li><li><code>cltv_expiry_delta</code>: This is the delta between the incoming HTLC’s CLTV and
outgoing HTLC’s CLTV that the node requires (more on this later).</li></ul><p>Here is the updated version of Alice’s graph view showing the <code>channel_update</code>
information she has about each channel in her graph.</p><p><img loading=lazy src=/onion_prelims/4-chan-updates.png#center alt></p><p>If we narrow down on the current goal which is to pay Dave, we can simplify this
diagram quite a bit to only show the relevant data. We only care about the
channels that are on a potential path between Alice and Dave and we only care
about the <code>channel_update</code> from nodes where we will potentially be sending
across their channel in the outbound direction. For example: Both Bob and
Charlie have advertised <code>channel_updates</code> referring to channel <code>BC</code>, but
because Alice only cares about the direction from Bob to Charlie, she only
needs to look at the information from Bob&rsquo;s <code>channel_update</code> for the channel
since it always refers to the outgoing direction.</p><p><img loading=lazy src=/onion_prelims/5-path-choices.png#center alt></p><p>The above diagram shows the two potential paths from Alice to Dave:</p><pre><code>1. Alice -&gt; Bob -&gt; Charlie -&gt; Dave via channels AB, BC and CD
2. Alice -&gt; Eve -&gt; Charlie -&gt; Dave via channels AE, EC and CD
</code></pre><p>If Alice is smart, she will pick the path which will cost her the least amount
of fees. Let’s do some calculations to determine which one would be more
cost-effective for her.</p><h3 id=path-1>Path 1<a hidden class=anchor aria-hidden=true href=#path-1>#</a></h3><p>To work out the total fees for a path, we have to work backwards from the
destination.</p><ul><li>We know that Dave should be paid 4999999 msats (he said so in his invoice)
which means that this is the number of sats that will be routed through
Charlie. So the amount of fees to pay to Charlie can be calculated as follows:</li></ul><pre><code> = Charlie’s Base Fee + Charlie’s proportional fee in parts per million/1000000 * (The amount routed through Charlie)
 = 100 + 1000/1000000(4999999)  
 = 100 + 4999999000/1000000
 = 100 + 4999.999
 = 5099.99
 ~ 5100
</code></pre><p>So the total number of sats that should be sent to Charlie is:</p><pre><code> = 4999999 + 5100 = 5005099 
 = 5005099 msats
</code></pre><ul><li>5005099 msats need to be routed through Bob, so the fee we would need to pay
to Bob is:</li></ul><pre><code> = 200 + 2000/1000000(5005099)
 = 200 + 2/1000(5005099)
 = 10211
</code></pre><p>So the total number of sats to send to Bob is:</p><pre><code> = 5005099 + 10211
 = 5015310
</code></pre><p>This means that Alice will pay the following amount in fees for the payment:</p><pre><code> = 5015310 - 4999999 
 = 15311 msats
</code></pre><h3 id=path-2>Path 2<a hidden class=anchor aria-hidden=true href=#path-2>#</a></h3><p>Alice will do the same type of calculation for the path 2.</p><ul><li>Charlie’s step will be the same: He must be paid a total of 5005099 msats.</li><li>Then we work out what we would need to pay Eve:</li></ul><pre><code>  = 300 + 3000/1000000(5005099)
  = 300 + 3/1000(5005099)
  = 15316 msats
</code></pre><p>So the total number of sats to send to Eve is:</p><pre><code>  = 5005099 + 15316
  = 5020415 msats
</code></pre><p>Ie, the total that Alice will pay in fees is:</p><pre><code>5020415-4999999 = 20416 msats
</code></pre><p>Aaaand the winner is: Path 1! Now we only need care about the following info:</p><p><img loading=lazy src=/onion_prelims/6-path1.png#center alt></p><h1 id=hop-payloads>Hop Payloads<a hidden class=anchor aria-hidden=true href=#hop-payloads>#</a></h1><p>Alice now has enough information to know what she wants to communicate to each
hop along the path.</p><p><img loading=lazy src=/onion_prelims/7-last-hop-info.png#center alt></p><p>Alice wants Dave to receive an <code>update_add_htlc</code> from Charlie on the <code>CD</code>
channel. The <code>payment_hash</code> should match the one specified in the invoice
received from Dave. The <code>amount_msat</code> will be 4999999 as specified in the
invoice. Alice then also checks the current block height (height 1001) and uses
that along with the <code>min_final_cltv_expiry_delta</code>(9) in the invoice to
calculate that the outgoing CLTV value on the HTLC should be 1010.</p><p>Using the fee calculation we did earlier for this path, Alice can also determine
what the <code>update_add_htlc</code>s should look like for the Bob-to-Charlie and
Alice-to-Bob steps. If the fact that the CLTVs for each HTLC increases from
right to left is confusing, check out <a href=#a-note-on-cltv-deltas>this</a> quick CLTV
delta explainer.</p><p><img loading=lazy src=/onion_prelims/8-other-hop-info.png#center alt></p><p>The only part of the puzzle that is missing here is: How does Alice tell
Charlie what to forward to Dave if she is only connected to Bob? This is where
the <code>onion_routing_packet</code> field in <code>update_add_htlc</code> comes in. Alice packages
up what she wants to tell each node and essentially then wraps it with the
payload for the previous node. The diagram below should make this more clear:</p><p><img loading=lazy src=/onion_prelims/9-onion-info.png#center alt></p><p>So Bob gets the information for him from Alice but also a packet that he should
forward to Charlie. Charlie gets this packet and reads the data meant for him
and sees that there is also a payload that he should forward on to Dave. Dave
gets his payload and sees that he is the final node in the path. At this point,
Dave will check if he has the pre-image for the incoming payment hash. Note that
this is where the idea of the &ldquo;onion&rdquo; comes in: each hop gets a packet that they
must &ldquo;peel&rdquo; like an onion.</p><h1 id=naive-onion-packet-construction>Naive Onion Packet Construction<a hidden class=anchor aria-hidden=true href=#naive-onion-packet-construction>#</a></h1><p>Let’s take a moment to imagine what the actual onion packets will look like.
Heads up here that this is <em>not</em> the final construction. I will build up a
possible structure here, and then I will explain why this is not the way things
actually look. The details of how this is actually done will be covered in the
<a href=../../posts/sphinx>next post</a>.</p><p>Ok so Alice knows what she wants to tell each of the hops. This is called the
“hop payload”. She puts together the following packet for Bob:</p><p><img loading=lazy src=/onion_prelims/10-naive-bob-pkt.png#center alt></p><p>The packet has the following components:</p><ul><li>1 byte packet version byte</li><li>Alice’s public key</li><li>The payloads for each hop. Note that each payload also has an HMAC which that
hop will need to pass the packet on to the next hop (this will be more clear
in a moment).</li><li>Finally, an HMAC produced by Alice using her key over the packet’s hop
payloads.</li></ul><p>(What is an HMAC? I&rsquo;ll explain this better in the next post but for now, just
think of it as a digital signature used to verify the integrity of a payload)</p><p>Bob will receive this packet and will do the following:</p><ol><li>He will check that the HMAC is valid (in other words he checks that the
packet has not been tampered with).</li><li>He will read the payload meant for him along with the HMAC.</li><li>He will reconstruct the packet that should be passed on to Charlie. He will
append the HMAC given to him by Alice for this packet since he cannot produce
this HMAC himself.</li></ol><p><img loading=lazy src=/onion_prelims/11-naive-charlie-pkt.png#center alt></p><p>Charlie will receive this packet and do the following:</p><ol><li>He will check that the HMAC is valid.</li><li>He will read the payload meant for him along with the HMAC</li><li>He will reconstruct the packet that should be passed on to Dave:</li></ol><p><img loading=lazy src=/onion_prelims/12-naive-dave-pkt.png#center alt></p><p>Dave will receive this packet and do the following:</p><ol><li>He will check that the HMAC is valid.</li><li>He will read the payload meant for him along with the HMAC.</li><li>The HMAC he receives will be an empty byte array. This indicates to Dave that
he is the final hop.</li></ol><p>Ok so what are some issues with this construction?</p><ul><li>Each hop can read the payload for each hop that follows. This leaks who the
receiver is.</li><li>Each hop is told Alice’s public key, and so they all know who is sending to
the receiver.</li><li>Even if the individual payloads were encrypted, the packet gets smaller and
smaller further along the path and so intermediary nodes would be able to
guess how far they are away from the final hop based on the packet length.</li></ul><p>In other words: privacy = bad. We can’t have that. Enter Sphinx packet
construction! With Sphinx packet construction:</p><ul><li>Each payload is encrypted so that it can only be decrypted by the node it was
meant for.</li><li>The sender does not share their real public key but instead use a different
ephemeral key for each hop.</li><li>The packet size remains constant at each hop.</li></ul><p>I’ll see you in the next post for all the details on this!</p><h1 id=a-note-on-cltv-deltas>A note on CLTV Deltas<a hidden class=anchor aria-hidden=true href=#a-note-on-cltv-deltas>#</a></h1><p>To understand why nodes advertise a CLTV delta and how this is used by the
sender of a payment to determine which CLTV to communicate to each hop, let’s
take a step back and just look at the structure of an HTLC:</p><p><img loading=lazy src=/onion_prelims/ctlv_delta_1.png#center alt></p><p>The diagram above shows the HTLC between Charlie and Dave (the last node on the
path). An HTLC has two possible spending paths: The pre-image path which will
pay the funds to Dave if he is able to produce the pre-image corresponding to
the payment hash. The other path is the timeout path which will pay the funds
back to Charlie. This timeout path is only spendable after the block height
defined by <code>CLTV A</code>. Let’s assume that the current block height is 1001. If
<code>CLTV A</code> is 1002, then there is a real chance that just as Dave is about to
reveal the pre-image to Charlie, block 1002 gets mined and Charlie quickly goes
ahead and broadcasts the transaction and spends the timeout path before Dave is
able to sweep the pre-image path. To prevent this race, Dave will want some time
where he can confidently spend the pre-image path if he needs to before the
timelock path becomes spendable. He communicates his desired buffer, 9 blocks,<br>using the <code>min_final_cltv_expiry_delta</code> field of the invoice that he sends to
Alice. Alice then knows that if she were to send the payment right now while
the block height is 1001, that Dave will fail any incoming HTLC with a <code>CLTV A</code>
smaller than 1010 (1001 + 9).</p><p>Now, let’s zoom out a bit more and include the HTLC between Bob and Charlie. We
want to now figure out what an appropriate value would be for the CLTV on the
HTLC between Bob and Charlie, <code>CLTV B</code>.</p><p><img loading=lazy src=/onion_prelims/cltv_delta_2.png#center alt></p><p>Let’s assume that Dave waits until the very last minute to reveal the pre-image
to Charlie. In other words, he waits until just before block 1010 is mined.
Charlie now needs to turn around and present this pre-image to Bob. In the case
that Bob goes on-chain with the HTLC, Charlie requires some time where he can
spend the pre-image path without worrying about Bob being able to spend the
timeout path. This buffer that Charlie requires between receiving the pre-image
from Dave and being able to spend the pre-image path safely from the HTLC with
Bob is Charlie’s CLTV delta. He will advertise this value in his
<code>channel_update</code> and he expects Alice to use that value when constructing her
payment path. If a payment comes through to Bob and the difference between
<code>CLTV_B</code> and <code>CLTV_A</code> value is less than the delta that he advertised, he will
fail the payment. He requires that <code>CLTV_B</code> be equal to at least <code>CLTV_A</code> plus
his advertised CLTV delta.</p><h1 id=bonus-section-hop-hints>Bonus Section: Hop Hints<a hidden class=anchor aria-hidden=true href=#bonus-section-hop-hints>#</a></h1><p>This post is a good place to quickly cover what you need to know about hop
hints and how they affect the process of path finding.</p><p>If we go back to the image of Alice’s view of the graph based on the
<code>channel_announcement</code>s that she has received, there is a chance that Alice
actually doesn’t know about the channel between Charlie and Dave (Channel
<code>CD</code>). This is because it might be a private channel that Charlie and Dave
chose not to announce to the network.</p><p><img loading=lazy src=/onion_prelims/13-graph-private-hop.png#center alt></p><p>In this case, Alice will not be able to find a path to Dave’s node unless he
provides her with more information in the invoice he sends her. The extra
information that Dave may provide is made up of one or more “Hop Hints”. These
hints need to make up for any information that Alice would have received from a
<code>channel_announcement</code> and <code>channel_update</code> for the channel. This information
includes Charlie’s public key, the SCID of the channel and then all the routing
policy rules for the channel.</p><p><img loading=lazy src=/onion_prelims/14-invoice-hop-hint.png#center alt></p><p>The rest of the path finding process is the same :)</p><h1 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h1><p>Alrighty! I hope things are making a bit more sense now and that you understand
both how a sender goes about finding a path to a destination node along with
what the sender needs to communicate to each node on the path. In the
<a href=../../posts/sphinx>next post</a> we will take a deep dive into exactly how the onion packet
carrying the hop payloads is constructed to maintain maximum privacy.</p></div><footer class=post-footer><ul class=post-tags></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Lightning Network Onion Routing: Preliminaries on twitter" href="https://twitter.com/intent/tweet/?text=Lightning%20Network%20Onion%20Routing%3a%20Preliminaries&url=https%3a%2f%2fwww.ellemouton.com%2fposts%2fonion-routing-prelims%2f&hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Lightning Network Onion Routing: Preliminaries on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.ellemouton.com%2fposts%2fonion-routing-prelims%2f&title=Lightning%20Network%20Onion%20Routing%3a%20Preliminaries&summary=Lightning%20Network%20Onion%20Routing%3a%20Preliminaries&source=https%3a%2f%2fwww.ellemouton.com%2fposts%2fonion-routing-prelims%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Lightning Network Onion Routing: Preliminaries on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.ellemouton.com%2fposts%2fonion-routing-prelims%2f&title=Lightning%20Network%20Onion%20Routing%3a%20Preliminaries"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Lightning Network Onion Routing: Preliminaries on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.ellemouton.com%2fposts%2fonion-routing-prelims%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Lightning Network Onion Routing: Preliminaries on whatsapp" href="https://api.whatsapp.com/send?text=Lightning%20Network%20Onion%20Routing%3a%20Preliminaries%20-%20https%3a%2f%2fwww.ellemouton.com%2fposts%2fonion-routing-prelims%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Lightning Network Onion Routing: Preliminaries on telegram" href="https://telegram.me/share/url?text=Lightning%20Network%20Onion%20Routing%3a%20Preliminaries&url=https%3a%2f%2fwww.ellemouton.com%2fposts%2fonion-routing-prelims%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer><script src=https://utteranc.es/client.js repo=ellemouton/website issue-term=pathname theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.ellemouton.com>Elle Mouton</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>