<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Opening and announcing a pre-taproot LN channel | Elle Mouton</title><meta name=keywords content><meta name=description content="A deep dive into opening a pre-taproot Lightning Network channel"><meta name=author content="map[email:elle.mouton@gmail.com name:Elle Mouton]"><link rel=canonical href=https://www.ellemouton.com/posts/open_channel_pre_taproot/><link crossorigin=anonymous href=/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://www.ellemouton.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.ellemouton.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.ellemouton.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.ellemouton.com/apple-touch-icon.png><link rel=mask-icon href=https://www.ellemouton.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-PMLX8P6J9S"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-PMLX8P6J9S',{anonymize_ip:!1})}</script><meta property="og:title" content="Opening and announcing a pre-taproot LN channel"><meta property="og:description" content="A deep dive into opening a pre-taproot Lightning Network channel"><meta property="og:type" content="article"><meta property="og:url" content="https://www.ellemouton.com/posts/open_channel_pre_taproot/"><meta property="og:image" content="https://www.ellemouton.com/openChanPt1/open-chan-cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-23T00:00:00+00:00"><meta property="article:modified_time" content="2023-01-23T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.ellemouton.com/openChanPt1/open-chan-cover.png"><meta name=twitter:title content="Opening and announcing a pre-taproot LN channel"><meta name=twitter:description content="A deep dive into opening a pre-taproot Lightning Network channel"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://www.ellemouton.com/posts/"},{"@type":"ListItem","position":3,"name":"Opening and announcing a pre-taproot LN channel","item":"https://www.ellemouton.com/posts/open_channel_pre_taproot/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Opening and announcing a pre-taproot LN channel","name":"Opening and announcing a pre-taproot LN channel","description":"A deep dive into opening a pre-taproot Lightning Network channel","keywords":[],"articleBody":"In this article, I will go over the process of opening a Lightning Network channel as it works today (pre taproot channels). I will start with the channel_open message and will talk in detail about it and all the messages involved in “opening” the channel ending with the channel_announcement message.\nMy goal for this article is to recap today’s channel open flow so that we can later focus only on the changes required for opening a taproot channel1.\nThis article replaces my previous short article on channel opens. It includes more detail and more diagrams (yay diagrams!). I will assume that the reader understands the structure of a commitment transaction and understands why they are asymmetric. If you feel a bit rusty in this area, please check out my articles explaining these concepts in detail.\nThe end goal Before we dig into the first step, I think it is useful to illustrate the goal we are trying to reach. I will once again use our trusty peers, Alice and Bob, to tell the story.\nAlice and Bob are both Lightning Network nodes. Alice’s node ID (ie, the public key used to identify her node) is alice_node_id and Bob’s node ID is bob_node_id. Their main two goals are:\n They want to open a channel between themselves in a trustless way. They want to be able to advertise their new channel so that the rest of the network can use it for routing.  Opening the channel A channel is opened once both parties have the ability to fully sign their respective commitment transactions and once the funding transaction is on chain. Throughout this explanation, I will use diagrams and colours to illustrate the process. In the diagrams, a white background means that the field of the transaction is not yet known. A coloured-in field indicates that the field value is known. Any green fields are used to highlight any of Alice’s public keys or signatures and any blue fields are used to show Bob’s.\nThere are three transactions in play for the opening of a channel. The first is the funding transaction which will need to go on chain. The other two are the first commitment transactions held by Alice and Bob describing the initial state of the channel.\nHere are the diagrams used to describe the three transactions. Note that at the moment we still don’t know anything about the parameters of the channel and so all fields still have a white background. Remember that our end goal is to have all these fields coloured in.\nThe open_channel message The first step of the process is Alice deciding that she wants to open a channel with Bob. In doing so, she also becomes the funder of the channel. Let’s say that Alice decides that she wants to open a 1 BTC channel and wants to immediately give Bob half of the channel’s capacity (0.5 BTC). Alice will now put together an open_channel message that she will send to Bob. Let’s take a look at the relevant open_channel parameters (I am leaving out any parameters that don’t have anything to do with the channel-open phase). You can skip this table if you want. It is just a reference for incase you want to check what the meaning of a field is.\nLet’s now fill in Alice’s values for these fields:\nAlice sends this message over to Bob.\nSince Alice has decided on the type of channel she wants to open (default channel type as opposed to an anchors, taproot etc) as well as the channel capacity, she can already piece together quite a large part of the funding transaction:\nSince she knows the capacity of the channel she wants to open, she can choose some of her UTXOs to be inputs to the funding transaction. Since Alice does not yet know which pub key Bob would want to use for the channel, she cannot yet finalise the channel funding output and hence can also not yet produce signatures for the inputs.\nSince Alice has decided on the channel type (and hence the commitment transaction structure), she can also start putting together the pieces of the commitment transactions. If we assume that Bob is delighted by this channel-opening proposal from Alice, then from this open_channel message, he can also start putting together the pieces. Remember that both parties will need to construct both commitment transactions since they will both need to be able to sign their peer’s transactions. Let’s take a look at what pieces they are now both able to fill in:\nAlice’s commitment transaction has filled in quite nicely. It has the structure of a default, non-anchor channel transaction and all her public keys have been filled in (alice_local_delayed_pk_1 is derived using her delayed_payment_basepoint and her first_commitment_point). Since she hasn’t received any messages from Bob yet, she has not yet been able to fill in any of his pub keys and since the funding transaction is still incomplete, she also can’t yet know the TXID to point the input of this commitment transaction to.\nBob’s commitment transaction (from his perspective) is looking a bit more complete:\nLike Alice, he also cannot yet fill in the funding transaction’s TXID, but he can fill in a few other things:\n The alice_pubkey_1, alice_to_self_delay, push_amt and local_amt values are taken as is from the open_channel message alice_payment_key_1 is derived using Alice’s payment_basepoint and first_commitment_point revoke_pubkey_1b is derived using Alice’s revocation_basepoint and Bob’s first_per_commitment point (at this point Alice cannot derive this point yet since she has not received his first_per_commitment_point)  Ok cool! Time for Bob to indicate to Alice his acceptance of the request by sending the next message: accept_channel\nThe accept_channel message The message shares many of the fields from open_channel. Here is the message that Bob will put together:\nWhen Alice gets this message from Bob, she can now complete the funding transaction’s output and can create the signatures for the inputs. Since everything is filled in, the TXID for the funding tx is now also known.\nAlice can now also further fill in her own commitment transaction:\n she is now able to use the values sent by Bob to fill in bob_pubkey_1, bob_payment_key_1, bob_to_self_delay and revoke_pubkey_1a since the TXID for the funding tx is now known, she can complete the input too.  She now knows everything she needs to know in order to sign this transaction herself but she is still missing Bob’s signature for this transaction.\nBob’s view of his commitment transaction is still the same as before since he learned no new info after sending the accept_channel message.\nNow that Alice knows the txid for the funding transaction, she is also able to complete her view of Bob’s commitment transaction and so she can produce her signature for his transaction. This is where the next message comes in: funding_created.\nThe funding_created message Alice will now use the funding_created message to tell Bob the TXID and index of the funding transaction along with her signature for Bob’s commitment transaction. Note that he still wont be able to broadcast his transaction since Alice has not yet broadcast the funding transaction.\nOnce the funding message has been received, Bob can fill in the rest of his commitment transaction:\nAlice won’t broadcast the funding transaction until she has a valid signature from Bob for her commitment transaction. Enter funding_signed:\nNotice that this is the first message to use the real channel ID instead of the temporary one.\nThis was the last piece of the puzzle for Alice. She now has all the info she needs to be able to sign her commitment transaction if ever needed.\nAlice can now safely broadcast the funding transaction. Both she and Bob will watch the chain for the confirmation of the funding transaction. Once it has reached the minimum_depth specified by Bob in accept_channel, both sides will exchange the channel_ready message (previously named funding_locked). This message serves as both a signal to the peer to indicate to them that the channel is ready for use (and that the channel announcement process can now start if the peers decided on an announced channel) and also to send across each peer’s second_per_commitment_point that they should use in their second commitment transaction.\nOk cool! We have completed our first goal: Alice and Bob have opened a channel between themselves in a trust-less way. Now we move on to step 2: announcing this channel to the network!\nAnnouncing the channel This part is fairly painless. Basically there is just one message, channel_announcement, that Alice and Bob need to construct together and once it is complete, then they can broadcast it to the network. Other nodes will use this message to prove a few things:\n That the channel funding tx is actually an existing, unspent UTXO with an acceptable number of confirmations. That the funding transaction output actually looks like a lightning channel funding transaction That the channel is actually owned by the keys that Alice and Bob say they used to construct the channel. That Alice and Bob both agree on the message being broadcast.  An incomplete version of the channel_announcement message looks as follows:\nh is the hash of all the data that will be covered by the signatures. In order to complete the message, Alice and Bob both compute a signature over h using the private keys associated with their node IDs and the pubkeys they used in the funding transaction. They then both exchange the announcement_signatures message in order to communicate these signatures to each other:\nNow both nodes can put together the complete channel_announcement message:\nLet’s go over the steps that a node (Charlie) receiving this message will go through in order to verify the new channel that Alice and Bob claimed to have opened.\n First, Charlie will use the short_channel_id included in the message to make sure that the channel’s funding transaction actually exists on-chain, that it has a sufficient number of confirmations and that it is in fact unspent. Then, Charlie will also check that the unspent output actually does look like a Lightning channel owned by alice_pubkey_1 and bob_pubkey_1. He will do this by using the advertised pubkeys to reconstruct the P2WSH and ensure that it is the same as the one found on-chain. Now, Charlie will want to confirm that the nodes owning the pubkeys found in the channel funding output do in fact belong to the nodes owning the node ID pubkeys. This is done by verifying the alice_pubkey_1_sig and bob_pubkey_1_sig signatures. If these signatures are valid, then it is clear that the owners of alice_pubkey_1 and bob_pubkey_1 agree to being associated with alice_node_ID and bob_node_ID since the message signed includes these nodes IDs. Finally, Charlie will also want to ensure that owners of the node ID pubkeys agree to being associated with the new channel. This is done by verifying the alice_node_ID_sig and bob_node_ID_sig signatures. If these signatures are valid, then it is clear that the owners of alice_node_ID_sig and bob_node_ID_sig agree to being associated with alice_pubkey_1 and bob_pubkey_1 since the message signed includes these pubkeys.  Alice and Bob are done! Their channel is open and other nodes in the network, like Charlie, will happily use the new channel.\nIn the next post, I will dive into how the above process will change with taproot channels (given the current proposal). The main thing that will need to change is how signatures are dealt with. In all the above cases, Alice and Bob didn’t really need to do anything special when they were generating their signatures since they each would need to provide their own signature to sign for the 2-of-2 funding transaction. But with taproot, the funding output will use Musig2 to combine the pubkeys of Alice and Bob and so any signatures will need to involve the Musig2 signing protocol… But let’s leave the details of that for next time :)\n  https://github.com/lightning/bolts/pull/995 ↩︎\n   ","wordCount":"1981","inLanguage":"en","image":"https://www.ellemouton.com/openChanPt1/open-chan-cover.png","datePublished":"2023-01-23T00:00:00Z","dateModified":"2023-01-23T00:00:00Z","author":{"@type":"Person","name":{"email":"elle.mouton@gmail.com","name":"Elle Mouton"}},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.ellemouton.com/posts/open_channel_pre_taproot/"},"publisher":{"@type":"Organization","name":"Elle Mouton","logo":{"@type":"ImageObject","url":"https://www.ellemouton.com/favicon.ico"}}}</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:'\\[',right:'\\]',display:!0},{left:'$$',right:'$$',display:!0},{left:'\\(',right:'\\)',display:!1},{left:'$',right:'$',display:!1}],throwOnError:!1})})</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://www.ellemouton.com accesskey=h title="Elle Mouton (Alt + H)">Elle Mouton</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.ellemouton.com/CV_Elle_Mouton.pdf title=CV><span>CV</span></a></li><li><a href=https://www.ellemouton.com/archives title=Archive><span>Archive</span></a></li><li><a href=https://www.ellemouton.com/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Opening and announcing a pre-taproot LN channel</h1><div class=post-meta><span title="2023-01-23 00:00:00 +0000 UTC">January 23, 2023</span>&nbsp;·&nbsp;map[email:elle.mouton@gmail.com name:Elle Mouton]</div></header><figure class=entry-cover><img loading=lazy src=https://www.ellemouton.com/openChanPt1/open-chan-cover.png alt></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#the-end-goal aria-label="The end goal">The end goal</a></li><li><a href=#opening-the-channel aria-label="Opening the channel">Opening the channel</a><ul><li><a href=#the-open_channel-message aria-label="The open_channel message">The <code>open_channel</code> message</a></li><li><a href=#the-accept_channel-message aria-label="The accept_channel message">The <code>accept_channel</code> message</a></li><li><a href=#the-funding_created-message aria-label="The funding_created message">The <code>funding_created</code> message</a></li></ul></li><li><a href=#announcing-the-channel aria-label="Announcing the channel">Announcing the channel</a></li></ul></div></details></div><div class=post-content><p>In this article, I will go over the process of opening a Lightning Network
channel as it works today (pre taproot channels). I will start with the
<code>channel_open</code> message and will talk in detail about it and all the messages
involved in “opening” the channel ending with the <code>channel_announcement</code>
message.</p><p>My goal for this article is to recap today’s channel open flow so that we can
later focus only on the changes required for opening a taproot
channel<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><p>This article replaces my previous <a href=../creating-a-channel>short article on channel opens</a>. It includes
more detail and more diagrams (yay diagrams!). I will assume that the reader
understands the structure of a commitment transaction and understands why they
are asymmetric. If you feel a bit rusty in this area, please check out my
articles explaining these <a href=../updating-state>concepts in detail</a>.</p><h2 id=the-end-goal>The end goal<a hidden class=anchor aria-hidden=true href=#the-end-goal>#</a></h2><p>Before we dig into the first step, I think it is useful to illustrate the goal
we are trying to reach. I will once again use our trusty peers, Alice and Bob,
to tell the story.</p><p>Alice and Bob are both Lightning Network nodes. Alice’s node ID (ie, the public
key used to identify her node) is <code>alice_node_id</code> and Bob’s node ID is
<code>bob_node_id</code>. Their main two goals are:</p><ol><li>They want to open a channel between themselves in a trustless way.</li><li>They want to be able to advertise their new channel so that the rest of the
network can use it for routing.</li></ol><h2 id=opening-the-channel>Opening the channel<a hidden class=anchor aria-hidden=true href=#opening-the-channel>#</a></h2><p>A channel is opened once both parties have the ability to fully sign their
respective commitment transactions and once the funding transaction is on chain.
Throughout this explanation, I will use diagrams and colours to illustrate the
process. In the diagrams, a white background means that the field of the
transaction is not yet known. A coloured-in field indicates that the field value
is known. Any green fields are used to highlight any of Alice’s public keys or
signatures and any blue fields are used to show Bob’s.</p><p>There are three transactions in play for the opening of a channel. The first
is the funding transaction which will need to go on chain. The other two are the
first commitment transactions held by Alice and Bob describing the initial state
of the channel.</p><p>Here are the diagrams used to describe the three transactions. Note that at the
moment we still don’t know anything about the parameters of the channel and so
all fields still have a white background. Remember that our end goal is to have
all these fields coloured in.</p><p><img loading=lazy src=/openChanPt1/fntx_1.png#center alt>
<img loading=lazy src=/openChanPt1/1a_1.png#center alt>
<img loading=lazy src=/openChanPt1/1b_1.png#center alt></p><h3 id=the-open_channel-message>The <code>open_channel</code> message<a hidden class=anchor aria-hidden=true href=#the-open_channel-message>#</a></h3><p>The first step of the process is Alice deciding that she wants to open a channel
with Bob. In doing so, she also becomes the funder of the channel. Let’s say
that Alice decides that she wants to open a 1 BTC channel and wants to
immediately give Bob half of the channel’s capacity (0.5 BTC). Alice will now
put together an <code>open_channel</code> message that she will send to Bob. Let’s take a
look at the relevant <code>open_channel</code> parameters (I am leaving out any parameters
that don’t have anything to do with the channel-open phase). You can skip this
table if you want. It is just a reference for incase you want to check what the
meaning of a field is.</p><p><img loading=lazy src=/openChanPt1/open_channel_params.png#center alt></p><p>Let’s now fill in Alice’s values for these fields:</p><p><img loading=lazy src=/openChanPt1/open_chan.png#center alt></p><p>Alice sends this message over to Bob.</p><p>Since Alice has decided on the type of channel she wants to open (default
channel type as opposed to an anchors, taproot etc) as well as the channel
capacity, she can already piece together quite a large part of the funding
transaction:</p><p><img loading=lazy src=/openChanPt1/fntx_2.png#center alt></p><p>Since she knows the capacity of the channel she wants to open, she can choose
some of her UTXOs to be inputs to the funding transaction. Since Alice does not
yet know which pub key Bob would want to use for the channel, she cannot yet
finalise the channel funding output and hence can also not yet produce
signatures for the inputs.</p><p>Since Alice has decided on the channel type (and hence the commitment
transaction structure), she can also start putting together the pieces of the
commitment transactions. If we assume that Bob is delighted by this
channel-opening proposal from Alice, then from this <code>open_channel</code> message, he
can also start putting together the pieces. Remember that both parties will need
to construct both commitment transactions since they will both need to be able
to sign their peer’s transactions. Let’s take a look at what pieces they are now
both able to fill in:</p><p><img loading=lazy src=/openChanPt1/1a_2.png#center alt></p><p>Alice’s commitment transaction has filled in quite nicely. It has the structure
of a default, non-anchor channel transaction and all her public keys have been
filled in (<code>alice_local_delayed_pk_1</code> is derived using her
<code>delayed_payment_basepoint</code> and her <code>first_commitment_point</code>). Since she hasn’t
received any messages from Bob yet, she has not yet been able to fill in any of
his pub keys and since the funding transaction is still incomplete, she also
can’t yet know the TXID to point the input of this commitment transaction to.</p><p>Bob’s commitment transaction (from his perspective) is looking a bit more
complete:</p><p><img loading=lazy src=/openChanPt1/1b_2.png#center alt></p><p>Like Alice, he also cannot yet fill in the funding transaction’s TXID, but he
can fill in a few other things:</p><ul><li>The <code>alice_pubkey_1</code>, <code>alice_to_self_delay</code>, <code>push_amt</code> and <code>local_amt</code> values
are taken as is from the <code>open_channel</code> message</li><li><code>alice_payment_key_1</code> is derived using Alice’s <code>payment_basepoint</code> and
<code>first_commitment_point</code></li><li><code>revoke_pubkey_1b</code> is derived using Alice’s <code>revocation_basepoint</code> and Bob’s
<code>first_per_commitment</code> point (at this point Alice cannot derive this point yet
since she has not received his <code>first_per_commitment_point</code>)</li></ul><p>Ok cool! Time for Bob to indicate to Alice his acceptance of the request by
sending the next message: <code>accept_channel</code></p><h3 id=the-accept_channel-message>The <code>accept_channel</code> message<a hidden class=anchor aria-hidden=true href=#the-accept_channel-message>#</a></h3><p>The message shares many of the fields from <code>open_channel</code>. Here is the message
that Bob will put together:</p><p><img loading=lazy src=/openChanPt1/accept_channel.png#center alt></p><p>When Alice gets this message from Bob, she can now complete the funding
transaction’s output and can create the signatures for the inputs. Since
everything is filled in, the TXID for the funding tx is now also known.</p><p><img loading=lazy src=/openChanPt1/fntx_3.png#center alt></p><p>Alice can now also further fill in her own commitment transaction:</p><ul><li>she is now able to use the values sent by Bob to fill in <code>bob_pubkey_1</code>,
<code>bob_payment_key_1</code>, <code>bob_to_self_delay</code> and <code>revoke_pubkey_1a</code></li><li>since the TXID for the funding tx is now known, she can complete the input too.</li></ul><p>She now knows everything she needs to know in order to sign this transaction
herself <em>but</em> she is still missing Bob’s signature for this transaction.</p><p><img loading=lazy src=/openChanPt1/1a_3.png#center alt></p><p>Bob’s view of his commitment transaction is still the same as before since he
learned no new info after sending the <code>accept_channel</code> message.</p><p>Now that Alice knows the txid for the funding transaction, she is also able to
complete her view of Bob’s commitment transaction and so she can produce her
signature for his transaction. This is where the next message comes in:
<code>funding_created</code>.</p><h3 id=the-funding_created-message>The <code>funding_created</code> message<a hidden class=anchor aria-hidden=true href=#the-funding_created-message>#</a></h3><p>Alice will now use the <code>funding_created</code> message to tell Bob the TXID and index
of the funding transaction along with her signature for Bob’s commitment
transaction. Note that he still wont be able to broadcast his transaction since
Alice has not yet broadcast the funding transaction.</p><p><img loading=lazy src=/openChanPt1/funding_created.png#center alt></p><p>Once the funding message has been received, Bob can fill in the rest of his
commitment transaction:</p><p><img loading=lazy src=/openChanPt1/1b_3.png#center alt></p><p>Alice won’t broadcast the funding transaction until she has a valid signature
from Bob for her commitment transaction. Enter <code>funding_signed</code>:</p><p><img loading=lazy src=/openChanPt1/funding_signed.png#center alt></p><p>Notice that this is the first message to use the real channel ID instead of the
temporary one.</p><p>This was the last piece of the puzzle for Alice. She now has all the info she
needs to be able to sign her commitment transaction if ever needed.</p><p><img loading=lazy src=/openChanPt1/a1_4.png#center alt></p><p>Alice can now safely broadcast the funding transaction. Both she and Bob will
watch the chain for the confirmation of the funding transaction. Once it has
reached the <code>minimum_depth</code> specified by Bob in <code>accept_channel</code>, both sides
will exchange the <code>channel_ready</code> message (previously named <code>funding_locked</code>).
This message serves as both a signal to the peer to indicate to them that the
channel is ready for use (and that the channel announcement process can now
start if the peers decided on an announced channel) and also to send across each
peer’s <code>second_per_commitment_point</code> that they should use in their second
commitment transaction.</p><p><img loading=lazy src=/openChanPt1/channel_ready.png#center alt></p><p>Ok cool! We have completed our first goal: Alice and Bob have opened a channel
between themselves in a trust-less way. Now we move on to step 2: announcing
this channel to the network!</p><h2 id=announcing-the-channel>Announcing the channel<a hidden class=anchor aria-hidden=true href=#announcing-the-channel>#</a></h2><p>This part is fairly painless. Basically there is just one message,
<code>channel_announcement</code>, that Alice and Bob need to construct together and once
it is complete, then they can broadcast it to the network. Other nodes will use
this message to prove a few things:</p><ul><li>That the channel funding tx is actually an existing, unspent UTXO with an
acceptable number of confirmations.</li><li>That the funding transaction output actually looks like a lightning channel
funding transaction</li><li>That the channel is actually owned by the keys that Alice and Bob say they
used to construct the channel.</li><li>That Alice and Bob both agree on the message being broadcast.</li></ul><p>An incomplete version of the <code>channel_announcement</code> message looks as follows:</p><p><img loading=lazy src=/openChanPt1/channel_announcement.png#center alt></p><p><code>h</code> is the hash of all the data that will be covered by the signatures. In order
to complete the message, Alice and Bob both compute a signature over <code>h</code> using
the private keys associated with their node IDs and the pubkeys they used in the
funding transaction. They then both exchange the <code>announcement_signatures</code>
message in order to communicate these signatures to each other:</p><p><img loading=lazy src=/openChanPt1/announcement_sigs.png#center alt></p><p>Now both nodes can put together the complete <code>channel_announcement</code> message:</p><p><img loading=lazy src=/openChanPt1/channel_announcement_2.png#center alt></p><p>Let’s go over the steps that a node (Charlie) receiving this message will go
through in order to verify the new channel that Alice and Bob claimed to have
opened.</p><ol><li>First, Charlie will use the <code>short_channel_id</code> included in the message to make sure
that the channel’s funding transaction actually exists on-chain, that it has a
sufficient number of confirmations and that it is in fact unspent.</li><li>Then, Charlie will also check that the unspent output actually does look like a
Lightning channel owned by <code>alice_pubkey_1</code> and <code>bob_pubkey_1</code>. He will do this
by using the advertised pubkeys to reconstruct the P2WSH and ensure that it is
the same as the one found on-chain.</li><li>Now, Charlie will want to confirm that the nodes owning the pubkeys found in the
channel funding output do in fact belong to the nodes owning the node ID
pubkeys. This is done by verifying the <code>alice_pubkey_1_sig</code> and
<code>bob_pubkey_1_sig</code> signatures. If these signatures are valid, then it is clear
that the owners of <code>alice_pubkey_1</code> and <code>bob_pubkey_1</code> agree to being associated
with <code>alice_node_ID</code> and <code>bob_node_ID</code> since the message signed includes these
nodes IDs.</li><li>Finally, Charlie will also want to ensure that owners of the node ID pubkeys
agree to being associated with the new channel. This is done by verifying the
<code>alice_node_ID_sig</code> and <code>bob_node_ID_sig</code> signatures. If these signatures are
valid, then it is clear that the owners of <code>alice_node_ID_sig</code> and
<code>bob_node_ID_sig</code> agree to being associated with <code>alice_pubkey_1</code> and
<code>bob_pubkey_1</code> since the message signed includes these pubkeys.</li></ol><p>Alice and Bob are done! Their channel is open and other nodes in the network,
like Charlie, will happily use the new channel.</p><p>In the next post, I will dive into how the above process will change with
taproot channels (given the current proposal). The main thing that will need to
change is how signatures are dealt with. In all the above cases, Alice and Bob
didn&rsquo;t really need to do anything special when they were generating their
signatures since they each would need to provide their own signature to sign for
the 2-of-2 funding transaction. But with taproot, the funding output will use
Musig2 to combine the pubkeys of Alice and Bob and so any signatures will need
to involve the Musig2 signing protocol… But let’s leave the details of that for
next time :)</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><a href=https://github.com/lightning/bolts/pull/995>https://github.com/lightning/bolts/pull/995</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div><footer class=post-footer><ul class=post-tags></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Opening and announcing a pre-taproot LN channel on twitter" href="https://twitter.com/intent/tweet/?text=Opening%20and%20announcing%20a%20pre-taproot%20LN%20channel&url=https%3a%2f%2fwww.ellemouton.com%2fposts%2fopen_channel_pre_taproot%2f&hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Opening and announcing a pre-taproot LN channel on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.ellemouton.com%2fposts%2fopen_channel_pre_taproot%2f&title=Opening%20and%20announcing%20a%20pre-taproot%20LN%20channel&summary=Opening%20and%20announcing%20a%20pre-taproot%20LN%20channel&source=https%3a%2f%2fwww.ellemouton.com%2fposts%2fopen_channel_pre_taproot%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Opening and announcing a pre-taproot LN channel on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.ellemouton.com%2fposts%2fopen_channel_pre_taproot%2f&title=Opening%20and%20announcing%20a%20pre-taproot%20LN%20channel"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Opening and announcing a pre-taproot LN channel on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.ellemouton.com%2fposts%2fopen_channel_pre_taproot%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Opening and announcing a pre-taproot LN channel on whatsapp" href="https://api.whatsapp.com/send?text=Opening%20and%20announcing%20a%20pre-taproot%20LN%20channel%20-%20https%3a%2f%2fwww.ellemouton.com%2fposts%2fopen_channel_pre_taproot%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Opening and announcing a pre-taproot LN channel on telegram" href="https://telegram.me/share/url?text=Opening%20and%20announcing%20a%20pre-taproot%20LN%20channel&url=https%3a%2f%2fwww.ellemouton.com%2fposts%2fopen_channel_pre_taproot%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer><script src=https://utteranc.es/client.js repo=ellemouton/website issue-term=pathname theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.ellemouton.com>Elle Mouton</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>