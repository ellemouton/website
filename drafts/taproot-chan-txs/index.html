<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Taproot Channel Transactions | Elle Mouton</title><meta name=keywords content><meta name=description content="A deep-dive into the structure of Taproot channel transactions"><meta name=author content><link rel=canonical href=https://www.ellemouton.com/drafts/taproot-chan-txs/><link crossorigin=anonymous href=/assets/css/stylesheet.min.6f60056d44d3f7eb69a4bc6c332b59960f3a995802bded244750232f33713c49.css integrity="sha256-b2AFbUTT9+tppLxsMytZlg86mVgCve0kR1AjLzNxPEk=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://www.ellemouton.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.ellemouton.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.ellemouton.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.ellemouton.com/apple-touch-icon.png><link rel=mask-icon href=https://www.ellemouton.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.85.0"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-PMLX8P6J9S"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-PMLX8P6J9S',{anonymize_ip:!1})}</script><meta property="og:title" content="Taproot Channel Transactions"><meta property="og:description" content="A deep-dive into the structure of Taproot channel transactions"><meta property="og:type" content="article"><meta property="og:url" content="https://www.ellemouton.com/drafts/taproot-chan-txs/"><meta property="og:image" content="https://www.ellemouton.com/taprootChanTxs/taproot-chans-cover.png"><meta property="article:section" content="drafts"><meta property="article:published_time" content="2023-04-24T00:00:00+00:00"><meta property="article:modified_time" content="2023-04-24T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.ellemouton.com/taprootChanTxs/taproot-chans-cover.png"><meta name=twitter:title content="Taproot Channel Transactions"><meta name=twitter:description content="A deep-dive into the structure of Taproot channel transactions"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Drafts","item":"https://www.ellemouton.com/drafts/"},{"@type":"ListItem","position":3,"name":"Taproot Channel Transactions","item":"https://www.ellemouton.com/drafts/taproot-chan-txs/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Taproot Channel Transactions","name":"Taproot Channel Transactions","description":"A deep-dive into the structure of Taproot channel transactions","keywords":[],"articleBody":"Hold on to your hats folks, things are about to get real.\nOverview In this post, I will dive into the structure of Taproot channel funding and commitment transactions. If you missed my previous post about Taproot and MuSig2, it might be a good idea to read that one first for a recap of the building blocks that will be used throughout this post. If you perhaps also need a re-cap of the general structure of commitment transactions then check out this post where I cover why each output in a commitment transaction looks the way it does.\nNote that Taproot Channels are still in the design phase and so until the proposal by the one and only Roasbeef is merged, this blog post will be a living document that I will update if any changes are made to the proposal. There are currently even a few open questions in the proposal which I will try to illustrate here.\nIf you have read some of my previous blog posts, you might have noticed that I love to make use of diagrams. Well this post is diagrams on steroids. To help with understanding, here is a legend showing what each colour generally represents:\nOk, ready? Let’s dive in!\nFunding Transaction Output The funding transaction output is the output that defines the opening of the channel. In pre-taproot channels, this output pays into a 2-of-2 multisig meaning that any transaction (commitment or closing transaction) spending from the output must be signed by both channel peers. Since the output is a P2SH, once it is spent, the underlying 2-of-2 multisig is revealed in the witness and so it becomes pretty clear to anyone observing the chain that the transaction was for a Lightning channel.\nIn the case of Taproot channels, this output is now a 2-of-2 MuSig2. Both parties will still need to sign each transaction that spends from the output, however, the signatures will now be aggregated via the MuSig2 protocol into a single signature. This means that in the ideal case where the channel is closed in a cooperative manner, the channel will look no different from any other P2TR key-path spend. This is a huge privacy improvement for unannounced channels since there is no way to tell that the transaction was for a Lightning channel, and it never gets advertised to the network through the gossip protocol. As for announced Taproot channels, the gossip protocol will actually need to be completely re-designed to support the new channel type and there is currently an ongoing debate around if this new gossip version should advertise the channel’s funding transaction at all or not. More on Taproot channel gossip in a future post.\nHere is a diagram showing how a Taproot channel funding output is constructed:\nThe two parties in a channel, the local and remote peer, use the MuSig2 protocol to aggregate their individual funding keys, P_a and P_b, into the aggregate key, P_agg, which is also the internal key. This internal key is then tweaked with a BIP86 tweak. You might recall from the previous post that a BIP86 tweak gives the channel owners the ability to prove to other nodes on the network that this funding output does not have a hidden script path.\nSpending from the funding transaction The funding output can only ever be spent via the key path. Since the internal key is an aggregate key produced via MuSig2, to spend it requires both parties to produce partial signatures for the message being signed. These signatures are then aggregated using the MuSig2 PartialSigAgg function and finally tweaked with the tweak, T, to produce the signature that would validly spend the funding output.\nNotice that unlike in pre-taproot channels where spending from the funding output would require two signatures created completely independently of each other, in Taproot channels, the signatures are created in an interactive manner between the peers. I will cover the details of how exactly this affects the interaction between the peers in the next blog post.\nCommitment Transaction Outputs There are six different outputs that a commitment transaction can have. These are: the to_local and to_remote outputs, the local and remote anchor outputs, the offered htlc output and the accepted htlc output. Let’s dive in.\nThe to_local output The to_local output is responsible for paying the local peer their channel balance. The output must be revocable by the remote party at all times and only after to_self_delay blocks should the local party be able to spend from the output. The revocation key is used as the internal key and the to-local delayed script is then placed in the TapTree.\nKey path spend The internal key is the revocation key which will only be spendable by the remote peer iff the state associated with this commitment transaction has been revoked (see more on revocation “here”) . Thus, if the local party tries to cheat the remote party by publishing an old state, the remote party will be able to sweep via the key path which is also the most cost-effective spending path.\nScript path spend If this commitment transaction ends up on-chain as part of an honest force-close scenario then the remote party will not be able to spend via the revocation key. In this case, the transaction will be spendable by the local party via the script path after to_self_delay blocks have been confirmed. The following diagram shows the witness that will be required to spend this path:\nIt contains a witness for the local-delayed script which is a valid signature from the local party for their key, P_local_delayed. The script itself must also be revealed and finally, the control block must be specified. In this case, the control block only contains the parity bit of to_local output’s output key along with the internal key. Note that no inclusion proof needs to be included in the control block since there is only one script in the Taproot script tree which means that the script root can be calculated straight from the local-delayed script.\nThe to_remote output This output pays the remote party their channel balance. As with all anchor channels, any non-anchor outputs must have a CSV of at least one to not break the CPFP carve out rule. Therefore, the remote party is only allowed access to their funds after one confirmation. This type of requirement can only be added in a script and so this output also makes use of the Taproot script tree.\nYou might think there is a mistake in the diagram above in the to-remote script. I said before that we want to enforce a CSV of one here and yet the script does not have OP_1 in it. This is in-fact not a mistake but a cool Script trick! If the  OP_CHECKSIG check fails, then the script will fail immediately. However, if it passes, it will push the OP_1 to the stack that we will use in the CSV check. It does, however, seem as if this neat trick might be replaced with a more explicit OP_1 OP_CHECKSEQUENCEVERIFY for legibility reasons.\nAt this point, you are likely wondering about the internal key. We only require one spend path for this output, but unfortunately we had to put it in the script tree. We still have to set an internal key, however, even though we don’t ever want anyone to be able to spend from it. From the diagram you can see that the spec currently sets this key to the same aggregate public key used in the funding transaction. The idea here being that if P_agg internal key, then we know that it would require cooperation among the two peers to spend via this key but there is really no reason for either party to want to do so. This effectively cancels out the key path.\nSome reviewers of the proposal have noted that using P_agg as the internal key here makes recovery for the remote peer basically impossible if they find them selves in a situation where they have lost all channel data, all channel backups and only have their master seed left. With legacy channels, remote parties who have lost all their channel data are still able to scan the chain for to_remote outputs that belong to them since they know the derivation path that would be used for deriving these keys. This property will be lost if P_agg is used as the internal key in the Taproot channel case because the remote party would not be able to derive it and thus would not be able to scan the chain for their outputs. It has therefore been suggested that instead of using P_agg here, that a public NUMS point be used instead. If a public NUMS point is used, then the remote nodes will once again retain the ability to scan the chain for to_remote outputs belonging to them.\nScript path spend Once the commitment transaction has one confirmation, the remote peer can spend it via the script path using the following witness:\nRemote Anchor Output This is the output that the remote party will be able to use to CPFP the commitment transaction if required. The remote party’s public key is thus used as the internal key. To ensure that this output (a very small output of only 330 satoshis) is definitely cleaned up at some point from the UTXO set, another output path is added which allows anyone to spend the output after it has been confirmed for 16 blocks. This extra path is added as a script in the script tree.\nKey path spend Spending via the key path just requires a signature from the remote party which they will tweak with the TapTweak.\nScript path spend Once the output has been confirmed for 16 blocks, it becomes fair game. Anyone is allowed to spend from this output as long as they can produce the following spending script:\nNotice anything here? If you were a third party trying to sweep some expired anchor outputs for some free sats, would you be able to produce the above spending script? The answer is: yes, but only if you know what P_remote is! Before reading on, I suggest taking some time to think about how you could possibly come to know what P_remote is. It is not present in the funding transaction, nor is it present in the commitment transaction. Scroll up through the diagrams to see if you can see where it revealed.\nOk ready? It is only revealed if the to_remote output is spent as it appears in the witness required to spend that output. This means that the remote anchor is spendable by anyone after 16 blocks only when the to_remote output has been spent.\nLocal Anchor Output This is the output that you, the local party, will be able to use to CPFP the commitment transaction. And just like the remote anchor, it is spendable by anyone after 16 blocks. So the internal key is P_local_delayed and the “anyone can spend after 16 blocks” script is put in the script tree.\nKey path spend Spending via the key path just requires a signature from the local party which they will tweak with the TapTweak.\nScript path spend Just like the remote anchor, the parties wanting to spend via the “anyone can spend” path require the P_local_delayed public key to first be revealed. This is revealed when the to_local output is spent by the local party via the script path.\nThere is, however, one very important difference between the to_local and to_remote output: the to_remote output can only be spent via the script path which means that P_remote is always revealed. However, the to_local output can be spent via two paths! In the ideal case, it is spent via the script path in which case the P_local_delayed is revealed and there is no issue. But in the bad case, the to_local output is spent via the revocation path in which case P_local_delayed will not be revealed. In that case only the two channel peers would ever have the information required to spend the local anchor.\nAn alternative that has been suggested is that the to_local output be changed to force the reveal of P_local_delayed no matter how it is spent. This could be done by changing the key path to be a public NUMS point and then moving the revocation path to the script tree and adjusting the script so that the P_local_delayed key is embedded in it so that it must be revealed if the revocation path is spent. The downside here is that this increases the spend cost of both output paths of the to_local output. The question comes down to how much we want to cater for this very rare edge case.\nOffered HTLC Output An offered HTLC pays out to the remote party if they reveal the pre-image to a given hash before a certain CLTV timeout. After the timeout, the local party will be able to claim the output via the htlc-timeout transaction (details on that below). If the commitment transaction is a revoked state, then the remote party should be able to sweep the output at any time.\nKey path spend The internal key is set to the revocation key which is spendable only by the remote party and only if the commitment transaction is for a revoked state. If this is the case, then the remote party can sweep the output with the following signature:\nScript path spends The other two spend paths, the success and timeout paths, are placed in the script tree and spending either of them requires providing a valid witness for the script, the script itself and a control block which this time does include an inclusion proof since more than one script is present in the tree.\nSuccess Path To spend via the success path, the following witness is required.\nTimeout Path The following witness is required to spend via the timeout path. The transaction that will spend the timeout path is the htlc-timeout transaction - more details on that transaction later on. If you need a recap on the reason why second-stage htlc transactions are necessary, check out this post.\nAccepted HTLC Output The accepted HTLC output pays out to an htlc-success transaction if we (the local party) are able to provide the pre-image for the given payment hash. Otherwise, after a certain cltv_expiry, the remote party will be able to sweep the funds back via the timeout path. If the commitment transaction is a revoked state, then the remote party should be able to sweep the output at any time.\nKey path spend The internal key is set to the revocation key which is spendable only by the remote party and only if the commitment transaction is for a revoked state. If this is the case, then the remote party can sweep the output with the following signature:\nScript path spends The other two spend paths, the success and timeout paths, are placed in the script tree and spending either of them requires providing a valid witness for the script, the script itself and a control block which this time does include an inclusion proof since more than one script is present in the tree.\nSuccess Path To spend via the htlc-success transaction, the following witness must be provided:\nTimeout Path To spend via the timout path, the remote party must provide the following witness:\nHTLC Timeout and Success Transactions The htlc-timeout and htlc-success transactions look mostly identical so here is one diagram to describe both:\nThe only difference between the htlc-success and htlc-timeout transactions would be the inputs they are spending and hence, the witness required for spending that input. The htlc-timeout transaction spends the timeout path of the offered HTLC output and the htlc-success transaction spends the success path of the accepted HTLC output.\nThe outputs of the htlc-success and htlc-timeout transactions are identical: they are immediately spendable by the remote party via the revocation path if the associated commitment transaction is for a revoked state. Otherwise, they are spendable by the local party after to_self_delay blocks have been confirmed.\nThe key path and script path spend scripts are exactly the same as for the to_local output.\nWrap Up If you have made it all the way through that, congrats! You should now have a pretty solid understanding of the structure of Taproot channel commitment transactions. My next blog post will cover how the various channel peer messages will need to be updated to support MuSig2 signing. I expect it to be a short and sweet one.\nAs always, if you have any questions, comments or corrections, please feel free to reach out to me.\n","wordCount":"2789","inLanguage":"en","image":"https://www.ellemouton.com/taprootChanTxs/taproot-chans-cover.png","datePublished":"2023-04-24T00:00:00Z","dateModified":"2023-04-24T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.ellemouton.com/drafts/taproot-chan-txs/"},"publisher":{"@type":"Organization","name":"Elle Mouton","logo":{"@type":"ImageObject","url":"https://www.ellemouton.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://www.ellemouton.com accesskey=h title="Elle Mouton (Alt + H)">Elle Mouton</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://www.ellemouton.com/archives title=Archive><span>Archive</span></a></li><li><a href=https://www.ellemouton.com/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Taproot Channel Transactions</h1><div class=post-meta><span title="2023-04-24 00:00:00 +0000 UTC">April 24, 2023</span></div></header><figure class=entry-cover><img loading=lazy src=https://www.ellemouton.com/taprootChanTxs/taproot-chans-cover.png alt></figure><div class=post-content><p>Hold on to your hats folks, things are about to get real.</p><h1 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h1><p>In this post, I will dive into the structure of Taproot channel funding and
commitment transactions. If you missed my <a href=../../posts/taproot-prelims>previous post</a> about
Taproot and MuSig2, it might be a good idea to read that one first for a recap
of the building blocks that will be used throughout this post. If you perhaps
also need a re-cap of the general structure of commitment transactions then
check out <a href=../../posts/htlc-deep-dive>this</a> post where I cover why each output in a
commitment transaction looks the way it does.</p><p>Note that Taproot Channels are still in the design phase and so until
the <a href=https://github.com/lightning/bolts/pull/995>proposal</a> by the one and only <a href=https://twitter.com/roasbeef>Roasbeef</a> is
merged, this blog post will be a living document that I will update if any
changes are made to the proposal. There are currently even a few open questions
in the proposal which I will try to illustrate here.</p><p>If you have read some of my previous blog posts, you might have noticed that I
love to make use of diagrams. Well this post is diagrams on steroids. To help
with understanding, here is a legend showing what each colour generally
represents:</p><p><img loading=lazy src=/taprootChanTxs/colour-legend.png#center alt></p><p>Ok, ready? Let&rsquo;s dive in!</p><h1 id=funding-transaction-output>Funding Transaction Output<a hidden class=anchor aria-hidden=true href=#funding-transaction-output>#</a></h1><p>The funding transaction output is the output that defines the opening of the
channel. In pre-taproot channels, this output pays into a 2-of-2 multisig
meaning that any transaction (commitment or closing transaction) spending from
the output must be signed by both channel peers. Since the output is a P2SH,
once it is spent, the underlying 2-of-2 multisig is revealed in the witness and
so it becomes pretty clear to anyone observing the chain that the transaction
was for a Lightning channel.</p><p>In the case of Taproot channels, this output is now a 2-of-2 MuSig2. Both
parties will still need to sign each transaction that spends from the output,
however, the signatures will now be aggregated via the MuSig2 protocol into a
single signature. This means that in the ideal case where the channel is closed
in a cooperative manner, the channel will look no different from any other P2TR
key-path spend. This is a huge privacy improvement for unannounced channels
since there is no way to tell that the transaction was for a Lightning channel,
and it never gets advertised to the network through the gossip protocol. As for
announced Taproot channels, the gossip protocol will actually need to be
completely re-designed to support the new channel type and there is currently an
ongoing debate around if this new gossip version should advertise the channel&rsquo;s
funding transaction at all or not. More on Taproot channel gossip in a future
post.</p><p>Here is a diagram showing how a Taproot channel funding output is
constructed:</p><p><img loading=lazy src=/taprootChanTxs/funding-output.png#center alt></p><p>The two parties in a channel, the local and remote peer, use the MuSig2
protocol to aggregate their individual funding keys, <code>P_a</code> and <code>P_b</code>, into the
aggregate key, <code>P_agg</code>, which is also the internal key. This internal key is
then tweaked with a BIP86 tweak. You might recall from the previous post that a
BIP86 tweak gives the channel owners the ability to prove to other nodes on the
network that this funding output does not have a hidden script path.</p><h2 id=spending-from-the-funding-transaction>Spending from the funding transaction<a hidden class=anchor aria-hidden=true href=#spending-from-the-funding-transaction>#</a></h2><p>The funding output can only ever be spent via the key path. Since the internal
key is an aggregate key produced via MuSig2, to spend it requires both parties
to produce partial signatures for the message being signed. These signatures are
then aggregated using the MuSig2 <code>PartialSigAgg</code> function and finally tweaked
with the tweak, <code>T</code>, to produce the signature that would validly spend the
funding output.</p><p><img loading=lazy src=/taprootChanTxs/funding-keypath.png#center alt></p><p>Notice that unlike in pre-taproot channels where spending from the funding
output would require two signatures created completely independently of each
other, in Taproot channels, the signatures are created in an interactive manner
between the peers. I will cover the details of how exactly this affects the
interaction between the peers in the next blog post.</p><h1 id=commitment-transaction-outputs>Commitment Transaction Outputs<a hidden class=anchor aria-hidden=true href=#commitment-transaction-outputs>#</a></h1><p>There are six different outputs that a commitment transaction can have. These
are: the <code>to_local</code> and <code>to_remote</code> outputs, the local and remote anchor
outputs, the offered htlc output and the accepted htlc output. Let’s dive in.</p><h2 id=the-to_local-output>The <code>to_local</code> output<a hidden class=anchor aria-hidden=true href=#the-to_local-output>#</a></h2><p>The <code>to_local</code> output is responsible for paying the local peer their channel
balance. The output must be revocable by the remote party at all times and only
after <code>to_self_delay</code> blocks should the local party be able to spend from the
output. The revocation key is used as the internal key and the to-local delayed
script is then placed in the TapTree.</p><p><img loading=lazy src=/taprootChanTxs/to-local-output.png#center alt></p><h3 id=key-path-spend>Key path spend<a hidden class=anchor aria-hidden=true href=#key-path-spend>#</a></h3><p>The internal key is the revocation key which will only be spendable by the
remote peer <em>iff</em> the state associated with this commitment transaction has been
revoked (see more on revocation “here”) . Thus, if the local party tries to
cheat the remote party by publishing an old state, the remote party will be able
to sweep via the key path which is also the most cost-effective spending path.</p><p><img loading=lazy src=/taprootChanTxs/to-local-key-path.png#center alt></p><h3 id=script-path-spend>Script path spend<a hidden class=anchor aria-hidden=true href=#script-path-spend>#</a></h3><p>If this commitment transaction ends up on-chain as part of an honest force-close
scenario then the remote party will not be able to spend via the revocation key.
In this case, the transaction will be spendable by the local party via the
script path after <code>to_self_delay</code> blocks have been confirmed. The following
diagram shows the witness that will be required to spend this path:</p><p><img loading=lazy src=/taprootChanTxs/to-local-script-spend.png#center alt></p><p>It contains a witness for the local-delayed script which is a valid signature
from the local party for their key, <code>P_local_delayed</code>. The script itself must
also be revealed and finally, the control block must be specified. In this case,
the control block only contains the parity bit of <code>to_local</code> output’s output key
along with the internal key. Note that no inclusion proof needs to be included
in the control block since there is only one script in the Taproot script tree
which means that the script root can be calculated straight from the
local-delayed script.</p><h2 id=the-to_remote-output>The <code>to_remote</code> output<a hidden class=anchor aria-hidden=true href=#the-to_remote-output>#</a></h2><p>This output pays the remote party their channel balance. As with all anchor
channels, any non-anchor outputs must have a CSV of at least one to not break
the <a href=https://bitcoinops.org/en/topics/cpfp-carve-out/>CPFP carve out</a> rule. Therefore, the remote party is only allowed
access to their funds after one confirmation. This type of requirement can only
be added in a script and so this output also makes use of the Taproot script
tree.</p><p><img loading=lazy src=/taprootChanTxs/to-remote-output.png#center alt></p><p>You might think there is a mistake in the diagram above in the to-remote script.
I said before that we want to enforce a CSV of one here and yet the script does
not have <code>OP_1</code> in it. This is in-fact not a mistake but a cool Script trick!
If the <code>&lt;remotepubkey> OP_CHECKSIG</code> check fails, then the script will fail
immediately. However, if it passes, it will push the <code>OP_1</code> to the stack that
we will use in the CSV check. It does, however, seem as if this neat trick might
be replaced with a more explicit <code>OP_1 OP_CHECKSEQUENCEVERIFY</code> for legibility
reasons.</p><p>At this point, you are likely wondering about the internal key. We only require
one spend path for this output, but unfortunately we had to put it in the
script tree. We still have to set an internal key, however, even though we don’t
ever want anyone to be able to spend from it. From the diagram you can see that
the spec currently sets this key to the same aggregate public key used in the
funding transaction. The idea here being that if <code>P_agg</code> internal key, then we
know that it would require cooperation among the two peers to spend via this key
but there is really no reason for either party to want to do so. This
effectively cancels out the key path.</p><p>Some <a href=https://github.com/lightningnetwork/lnd/pull/7333#discussion_r1082384984>reviewers</a> of the proposal have noted that using <code>P_agg</code>
as the internal key here makes recovery for the remote peer basically impossible
if they find them selves in a situation where they have lost all channel data,
all channel backups and only have their master seed left. With legacy channels,
remote parties who have lost all their channel data are still able to scan the
chain for <code>to_remote</code> outputs that belong to them since they know the derivation
path that would be used for deriving these keys. This property will be lost
if <code>P_agg</code> is used as the internal key in the Taproot channel case because the
remote party would not be able to derive it and thus would not be able to scan
the chain for their outputs. It has therefore been suggested that instead of
using <code>P_agg</code> here, that a public <a href=https://en.wikipedia.org/wiki/Nothing-up-my-sleeve_number>NUMS</a> point be used instead. If a
public NUMS point is used, then the remote nodes will once again retain the
ability to scan the chain for <code>to_remote</code> outputs belonging to them.</p><h3 id=script-path-spend-1>Script path spend<a hidden class=anchor aria-hidden=true href=#script-path-spend-1>#</a></h3><p>Once the commitment transaction has one confirmation, the remote peer can spend
it via the script path using the following witness:</p><p><img loading=lazy src=/taprootChanTxs/to-remote-script-path.png#center alt></p><h2 id=remote-anchor-output>Remote Anchor Output<a hidden class=anchor aria-hidden=true href=#remote-anchor-output>#</a></h2><p>This is the output that the remote party will be able to use to CPFP the
commitment transaction if required. The remote party’s public key is thus used
as the internal key. To ensure that this output (a very small output of only 330
satoshis) is definitely cleaned up at some point from the UTXO set, another
output path is added which allows anyone to spend the output after it has been
confirmed for 16 blocks. This extra path is added as a script in the script
tree.</p><p><img loading=lazy src=/taprootChanTxs/remote-anchor-output.png#center alt></p><h3 id=key-path-spend-1>Key path spend<a hidden class=anchor aria-hidden=true href=#key-path-spend-1>#</a></h3><p>Spending via the key path just requires a signature from the remote party which
they will tweak with the TapTweak.</p><p><img loading=lazy src=/taprootChanTxs/remote-anchor-key-path.png#center alt></p><h3 id=script-path-spend-2>Script path spend<a hidden class=anchor aria-hidden=true href=#script-path-spend-2>#</a></h3><p>Once the output has been confirmed for 16 blocks, it becomes fair game. Anyone
is allowed to spend from this output as long as they can produce the following
spending script:</p><p><img loading=lazy src=/taprootChanTxs/remote-anchor-script-path.png#center alt></p><p>Notice anything here? If you were a third party trying to sweep some expired
anchor outputs for some free sats, would you be able to produce the above
spending script? The answer is: yes, but only if you know what <code>P_remote</code> is!
Before reading on, I suggest taking some time to think about how you could
possibly come to know what <code>P_remote</code> is. It is not present in the funding
transaction, nor is it present in the commitment transaction. Scroll up through
the diagrams to see if you can see where it revealed.</p><p>Ok ready? It is only revealed if the <code>to_remote</code> output is spent as it appears
in the witness required to spend that output. This means that the remote anchor
is spendable by anyone after 16 blocks only when the <code>to_remote</code> output has been
spent.</p><h2 id=local-anchor-output>Local Anchor Output<a hidden class=anchor aria-hidden=true href=#local-anchor-output>#</a></h2><p>This is the output that you, the local party, will be able to use to CPFP the
commitment transaction. And just like the remote anchor, it is spendable by
anyone after 16 blocks. So the internal key is <code>P_local_delayed</code> and the “anyone
can spend after 16 blocks” script is put in the script tree.</p><p><img loading=lazy src=/taprootChanTxs/local-anchor-output.png#center alt></p><h3 id=key-path-spend-2>Key path spend<a hidden class=anchor aria-hidden=true href=#key-path-spend-2>#</a></h3><p>Spending via the key path just requires a signature from the local party which
they will tweak with the TapTweak.</p><p><img loading=lazy src=/taprootChanTxs/local-anchor-key-spend.png#center alt></p><h3 id=script-path-spend-3>Script path spend<a hidden class=anchor aria-hidden=true href=#script-path-spend-3>#</a></h3><p>Just like the remote anchor, the parties wanting to spend via the “anyone can
spend” path require the <code>P_local_delayed</code> public key to first be revealed. This
is revealed when the <code>to_local</code> output is spent by the local party via the
script path.</p><p><img loading=lazy src=/taprootChanTxs/local-anchor-script-path.png#center alt></p><p>There is, however, one very important difference between the <code>to_local</code>
and <code>to_remote</code> output: the <code>to_remote</code> output can only be spent via the script
path which means that <code>P_remote</code> is always revealed. However, the <code>to_local</code>
output can be spent via two paths! In the ideal case, it is spent via the script
path in which case the <code>P_local_delayed</code> is revealed and there is no issue. But
in the bad case, the <code>to_local</code> output is spent via the revocation path in which
case <code>P_local_delayed</code> will not be revealed. In that case only the two channel
peers would ever have the information required to spend the local anchor.</p><p>An alternative that has been suggested is that the <code>to_local</code> output be changed
to force the reveal of <code>P_local_delayed</code> no matter how it is spent. This could
be done by changing the key path to be a public NUMS point and then moving the
revocation path to the script tree and adjusting the script so that
the <code>P_local_delayed</code> key is embedded in it so that it must be revealed if the
revocation path is spent. The downside here is that this increases the spend
cost of both output paths of the <code>to_local</code> output. The question comes down to
how much we want to cater for this very rare edge case.</p><h2 id=offered-htlc-output>Offered HTLC Output<a hidden class=anchor aria-hidden=true href=#offered-htlc-output>#</a></h2><p>An offered HTLC pays out to the remote party if they reveal the pre-image to a
given hash before a certain CLTV timeout. After the timeout, the local party
will be able to claim the output via the htlc-timeout transaction (details on
that <a href=#htlc-timeout-and-success-transactions>below</a>). If the commitment
transaction is a revoked state, then the remote party should be able to sweep
the output at any time.</p><p><img loading=lazy src=/taprootChanTxs/offered-htlc-output.png#center alt></p><h3 id=key-path-spend-3>Key path spend<a hidden class=anchor aria-hidden=true href=#key-path-spend-3>#</a></h3><p>The internal key is set to the revocation key which is spendable only by the
remote party and only if the commitment transaction is for a revoked state. If
this is the case, then the remote party can sweep the output with the following
signature:</p><p><img loading=lazy src=/taprootChanTxs/offered-htlc-key-spend.png#center alt></p><h3 id=script-path-spends>Script path spends<a hidden class=anchor aria-hidden=true href=#script-path-spends>#</a></h3><p>The other two spend paths, the success and timeout paths, are placed in the
script tree and spending either of them requires providing a valid witness for
the script, the script itself and a control block which this time does include
an inclusion proof since more than one script is present in the tree.</p><h4 id=success-path>Success Path<a hidden class=anchor aria-hidden=true href=#success-path>#</a></h4><p>To spend via the success path, the following witness is required.</p><p><img loading=lazy src=/taprootChanTxs/offerend-htlc-success.png#center alt></p><h4 id=timeout-path>Timeout Path<a hidden class=anchor aria-hidden=true href=#timeout-path>#</a></h4><p>The following witness is required to spend via the timeout path. The transaction
that will spend the timeout path is the htlc-timeout transaction - more details
on that transaction later on. If you need a recap on the reason why second-stage
htlc transactions are necessary, check out <a href=../../posts/htlc-deep-dive>this</a> post.</p><p><img loading=lazy src=/taprootChanTxs/offered-htlc-timeout.png#center alt></p><h2 id=accepted-htlc-output>Accepted HTLC Output<a hidden class=anchor aria-hidden=true href=#accepted-htlc-output>#</a></h2><p>The accepted HTLC output pays out to an htlc-success transaction if we (the
local party) are able to provide the pre-image for the given payment hash.
Otherwise, after a certain <code>cltv_expiry</code>, the remote party will be able to sweep
the funds back via the timeout path. If the commitment transaction is a revoked
state, then the remote party should be able to sweep the output at any time.</p><p><img loading=lazy src=/taprootChanTxs/accepted-htlc-output.png#center alt></p><h3 id=key-path-spend-4>Key path spend<a hidden class=anchor aria-hidden=true href=#key-path-spend-4>#</a></h3><p>The internal key is set to the revocation key which is spendable only by the
remote party and only if the commitment transaction is for a revoked state. If
this is the case, then the remote party can sweep the output with the following
signature:</p><p><img loading=lazy src=/taprootChanTxs/accepted-htlc-key-path.png#center alt></p><h3 id=script-path-spends-1>Script path spends<a hidden class=anchor aria-hidden=true href=#script-path-spends-1>#</a></h3><p>The other two spend paths, the success and timeout paths, are placed in the
script tree and spending either of them requires providing a valid witness for
the script, the script itself and a control block which this time does include
an inclusion proof since more than one script is present in the tree.</p><h4 id=success-path-1>Success Path<a hidden class=anchor aria-hidden=true href=#success-path-1>#</a></h4><p>To spend via the htlc-success transaction, the following witness must be
provided:</p><p><img loading=lazy src=/taprootChanTxs/accepted-htlc-success.png#center alt></p><h4 id=timeout-path-1>Timeout Path<a hidden class=anchor aria-hidden=true href=#timeout-path-1>#</a></h4><p>To spend via the timout path, the remote party must provide the following
witness:</p><p><img loading=lazy src=/taprootChanTxs/accepted-htlc-timeout.png#center alt></p><h2 id=htlc-timeout-and-success-transactions>HTLC Timeout and Success Transactions<a hidden class=anchor aria-hidden=true href=#htlc-timeout-and-success-transactions>#</a></h2><p>The htlc-timeout and htlc-success transactions look mostly identical so here is
one diagram to describe both:</p><p><img loading=lazy src=/taprootChanTxs/htlc-txs.png#center alt></p><p>The only difference between the htlc-success and htlc-timeout transactions would
be the inputs they are spending and hence, the witness required for spending
that input. The htlc-timeout transaction spends the timeout path of the offered
HTLC output and the htlc-success transaction spends the success path of the
accepted HTLC output.</p><p>The outputs of the htlc-success and htlc-timeout transactions are identical:
they are immediately spendable by the remote party via the revocation path if
the associated commitment transaction is for a revoked state. Otherwise, they
are spendable by the local party after <code>to_self_delay</code> blocks have been
confirmed.</p><p>The key path and script path spend scripts are exactly the same as for
the <code>to_local</code> output.</p><h1 id=wrap-up>Wrap Up<a hidden class=anchor aria-hidden=true href=#wrap-up>#</a></h1><p>If you have made it all the way through that, congrats! You should now have a
pretty solid understanding of the structure of Taproot channel commitment
transactions. My next blog post will cover how the various channel peer messages
will need to be updated to support MuSig2 signing. I expect it to be a short and
sweet one.</p><p>As always, if you have any questions, comments or corrections, please feel free
to reach out to me.</p></div><footer class=post-footer><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Taproot Channel Transactions on twitter" href="https://twitter.com/intent/tweet/?text=Taproot%20Channel%20Transactions&url=https%3a%2f%2fwww.ellemouton.com%2fdrafts%2ftaproot-chan-txs%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Taproot Channel Transactions on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.ellemouton.com%2fdrafts%2ftaproot-chan-txs%2f&title=Taproot%20Channel%20Transactions&summary=Taproot%20Channel%20Transactions&source=https%3a%2f%2fwww.ellemouton.com%2fdrafts%2ftaproot-chan-txs%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Taproot Channel Transactions on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.ellemouton.com%2fdrafts%2ftaproot-chan-txs%2f&title=Taproot%20Channel%20Transactions"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Taproot Channel Transactions on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.ellemouton.com%2fdrafts%2ftaproot-chan-txs%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Taproot Channel Transactions on whatsapp" href="https://api.whatsapp.com/send?text=Taproot%20Channel%20Transactions%20-%20https%3a%2f%2fwww.ellemouton.com%2fdrafts%2ftaproot-chan-txs%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Taproot Channel Transactions on telegram" href="https://telegram.me/share/url?text=Taproot%20Channel%20Transactions&url=https%3a%2f%2fwww.ellemouton.com%2fdrafts%2ftaproot-chan-txs%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://www.ellemouton.com>Elle Mouton</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>