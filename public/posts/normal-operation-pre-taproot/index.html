<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Normal operation and closure of a pre-taproot LN channel | Elle Mouton</title>
<meta name="keywords" content="">
<meta name="description" content="A deep-dive into the normal operation and closure of a pre-taproot Lightning Network channel">
<meta name="author" content="map[email:elle.mouton@gmail.com name:Elle Mouton]">
<link rel="canonical" href="https://www.ellemouton.com/posts/normal-operation-pre-taproot/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css" integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe&#43;FVUFzPh7U=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://www.ellemouton.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://www.ellemouton.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://www.ellemouton.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://www.ellemouton.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://www.ellemouton.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PMLX8P6J9S"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-PMLX8P6J9S', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="Normal operation and closure of a pre-taproot LN channel" />
<meta property="og:description" content="A deep-dive into the normal operation and closure of a pre-taproot Lightning Network channel" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.ellemouton.com/posts/normal-operation-pre-taproot/" />
<meta property="og:image" content="https://www.ellemouton.com/normalChanOp/cover.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-14T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-06-14T00:00:00+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://www.ellemouton.com/normalChanOp/cover.png" />
<meta name="twitter:title" content="Normal operation and closure of a pre-taproot LN channel"/>
<meta name="twitter:description" content="A deep-dive into the normal operation and closure of a pre-taproot Lightning Network channel"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://www.ellemouton.com/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Normal operation and closure of a pre-taproot LN channel",
      "item": "https://www.ellemouton.com/posts/normal-operation-pre-taproot/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Normal operation and closure of a pre-taproot LN channel",
  "name": "Normal operation and closure of a pre-taproot LN channel",
  "description": "A deep-dive into the normal operation and closure of a pre-taproot Lightning Network channel",
  "keywords": [
    
  ],
  "articleBody": "I’ve previously written in depth about how Lightning channels are opened, but I’ve never gone into the details of the normal operations and closures of channels. Since I promised in my previous post about Taproot channel transactions that I would write a follow-up explaining how all the channel messages need to be updated in order to support the new MuSig2 signing required by Taproot channels, I think now is the time to finally dive into the normal channel operations and closures so that the follow-up post on how Taproot channels affect these operations is easier to parse.\nOverview In this blog post, I will talk about the normal operations of a channel. This involves understanding how HTLCs are added to a channel and how channel peers commit to a new state including these HTLCs. Then I will cover how a channel’s normal flow is re-established after a disconnection and finally, the cooperative channel closure flow will be covered. All of these topics are covered in Bolt 2, but I thought a diagram or two could help with understanding. I plan on doing all of this with a long-running example.\nPreliminaries Here are a few links that cover some preliminaries that might be useful for understanding this blog post:\nWhy channel peers have an asymmetric state and how they go about updating this state in a trust-less way: Updating State. What HTLC outputs look like on a commitment transaction: HTLC deep-dive. How two nodes go about opening a channel: Opening and announcing a pre-taproot LN channel. Normal Channel Operation Setting the scene Alice and Bob (hello old friends!) have successfully opened their channel. They have both seen that the funding transaction has confirmed, and they have exchanged the channel_ready message with each other to indicate that they are ready to use the channel. The state of their asymmetric commitment transactions currently look as follows:\nBoth commitment transactions spend the 2-of-2 multi-sig funding transaction output. Spending from this output requires a signature from both parties. The signatures are represented by the two boxes at the top of the commitment transactions. You can see from the diagram that Alice’s commitment transaction has a signature from Bob represented by the blue box (say it with me: “Bob is blue!”) and Bob has a signature from Alice for his commitment transaction represented by the green box (“Alice is green” doesn’t have quite the same ring to it). Each commitment transaction also has the to_local and to_remote outputs which pay the respective parties their current channel balance. Both Alice and Bob have the ability to sign their own commitment transaction at any time and broadcast it to the Bitcoin network. This would be a force close.\nFor the sake of making the next few diagrams in this article a bit simpler, I am going to ignore the funding transaction along with the to_local and to_remote outputs for a while since our initial focus is going to be on adding and removing HTLC outputs. So the above diagram can instead be represented as follows:\nA red coloured commitment transaction, as shown below, represents past, revoked commitment transactions. If Alice or Bob were to sign and broadcast one of their older revoked commitment transactions then the other side would be able to sweep all their funds. So these revoked transactions can effectively be considered invalid. The yellow commitment transactions represent the latest, valid set of commitment transactions. These are the commitment transactions that would be broadcast in a force close. Then finally, each side has what can be thought of as a “staging area” where changes to the commitment transaction can be proposed. Later on, either side can decide when it wants its counterparty to commit to the changes in their staging commitment transaction. For those of you who love a good analogy - this is very much like a git workflow: past commits are out of date, but they tell a nice story of what has happened, your latest committed changes represent the current state of your project and any changes that are not yet committed are in staging.\nAdding an HTLC When either Alice or Bob want to send a payment across the channel in question (which would happen if either of them wanted to send a payment themselves or if they are routing another node’s payment) then they would need to propose the inclusion of the HTLC to their channel peer. This is done with the update_add_htlc message:\nThe channel_id is used to communicate which channel this change should take place on, the id is an always-incrementing identifier for this proposed change from the sender. The amount_msat is the amount that should be attached to the HTLC output, the cltv_expiry is the block height that the HTLC should expire at and finally the onion_routing_packet and optional blinding_point both contain data that the recipient will use to determine where next to send the payment.\nSomething that definitely took me a while to wrap my head around is the fact that the sender of this message does not put this update in their own staging area commitment transaction yet. This is because the update is still “pending on the receiver” because the sender has not yet received any acknowledgement from receiver for the new update. This is to allow for the case where one peer sends an update and then immediately receives a commitment_signed message (more details on this later). In that case, there should be no ambiguity around which updates are included in the transaction being signed. Hopefully this makes more sense as we work through the example.\n⚙️ Step 1: Alice -\u003e Bob: update_add_htlc(A1) Ok so let’s say that Alice sends Bob an update_add_htlc. Let’s call this HTLC A1 since it is the first one that Alice (A) is sending to Bob. If Bob is happy with all the fields in the message, then he adds the HTLC to his staging area commitment transaction and Alice marks the HTLC as pending on Bob’s side but does not yet add it to her staging commitment transaction:\nNote that neither side has actually committed to this HTLC and so if Bob is a routing node for this payment, he should not yet send update_add_HTLC to the next hop in the route until A1 has been irrevocably committed. An HTLC addition or removal is only considered irrevocably committed once both parties in the channel have committed to the commitment transaction with or without it respectively.\nSomething that the more simplified diagram fails to show is that Alice’s main output in Bob’s staging commitment transaction (ie, the to_remote output) will now have the value of the added HTLC subtracted (along with the fees to cover the extra output). If the HTLC ends up succeeding then this amount will be added to Bob’s output and if it ends up failing, then it will be re-added to Alice’s output.\n⚙️ Step 2: Alice -\u003e Bob: update_add_htlc(A2) Even if they have not committed to HTLC A1 yet, that does not stop them from adding more changes to the staging area. So Alice is more than welcome to propose a new HTLC, A2, to Bob:\n⚙️ Step 3: Bob -\u003e Alice update_add_htlc(B1) Similarly, Bob can suggest a change B1 to Alice:\nCommitting to the current state At some point, one of the peers will want to make sure that the other peer has committed to the latest set of changes and revoke the previous valid state. This is done by sending the commitment_signed message:\nThe channel_id once again refers to the channel in question. The signature is the sender’s signature for the remote party’s staging area commitment transaction. num_htlcs refers to the number of HTLCs that the sender expects to be on the remote commitment transaction and this is then followed by htlc_signatures which is an array of num_hltcs signatures which are the sender’s signatures for each of the second-level HTLC transactions that the remote party would need to broadcast if they were ever to force close the channel. If you need a reminder about why the second-level HTLC transactions are needed, give this post a read.\n⚙️ Step 4: Alice -\u003e Bob: commitment_signed Let’s say that Alice sends this message to Bob. Bob will now have all the required signatures from Alice to broadcast his staging-area commitment transaction:\nNotice that Alice knew that her signature would need to cover the A1 and A2 HTLCs. This is fine because the underlying transport is guaranteed to be reliable and ordered meaning that if Bob was to receive Alice’s commitment_signed message then it means that he definitely received her update_add_htlc messages for A1 and A2. Alice and Bob both know that the signature should not cover the B1 HTLC since Alice has not sent an acknowledgement for it yet.\nAnother thing to notice is that Bob now actually has two valid commitment transactions since he has not yet revoked his previous state. He is, however, incentivised at this point to revoke his previous commitment transaction since the HTLCs on the new state are either:\nPayments to Bob himself meaning that he gains from committing to the new state. If he doesn’t commit to the new state, then Alice won’t either and so there would still exist a version of a commitment transaction that does not pay Bob his incoming funds. Similarly to the above point, if Bob is routing a payment, then he is also incentivised to try to get the HTLC irrevocably committed since he would earn routing fees if the payment succeeds. Finally, if Bob is making the payment himself, then the first state would in fact be more desirable to him since he strictly has less funds in the second state. However, the merchant that Bob is making the payment to won’t release the goods being purchased unless funds come through which won’t happen if Alice does not pass on the HTLC which she won’t do unless it has been irrevocably committed to. So again, Bob is incentivised to revoke his previous state. ⚙️ Step 5: Bob -\u003e Alice: revoke_and_ack In response to Alice’s commitment_signed, Bob sends the revoke_and_ack message:\nThe per_commitment_secret provides Alice with the information she needs in order to be able to spend any revocation path on Bob’s previously valid state. See this post for more details about how revocation works. The next_per_commitment_point gives Alice the information she needs in order to derive the revocation public key that will be used in Bob’s next commitment transaction. Once Alice receives this message, Bob’s previous commitment transaction has successfully been revoked. Note that this message explicitly acknowledges the commitment_signed message sent by Alice and by extension, since messages delivery is reliable and ordered, it also implicitly acknowledges the update_add_htlc messages that Alice sent for A1 and A2. Alice can therefore finally add A1 and A2 to her staging area commitment transaction since they are no longer pending on Bob’s side:\nLet’s clean up the diagram a bit…\nThat’s better.\nFrom the above diagram, notice that Alice’s and Bob’s latest commitment transactions are actually out of sync. This is fine since none of the updates have been irrevocably committed yet. That might seem hard to believe since the commitment transactions look so different so let’s walk through the consequences of either of these transactions ending up on-chain from the perspective of both sides.\nFrom Alice’s perspective:\nif her commitment transaction is broadcast, she gets back her original to_local amount. if Bob’s commitment transaction is broadcast, then Alice’s offered HTLCs (such as A1 and A2) will be on-chain. For offered HTLCs, Alice is sending sats out meaning that her to_local would be lower. But, if Bob was a router node for these HTLCs then he would not have forwarded them as they are not yet irrevocably committed meaning that he won’t receive the pre-images required to claim these HTLCs and Alice would be able to get her funds back via the timeout path. If Bob was the recipient of these HTLCs, then he would be able to produce the pre-image to claim the HTLCs, but then Alice would see the pre-image on-chain and would be able to claim the incoming HTLCs from their incoming channel and would thus have earned routing fees. From Bob’s perspective (very similar to the logic for Alice):\nif Alice’s commitment transaction is broadcast, Bob gets back his funds via the to_remote output. If Bob had to force close via his commitment transaction, then HTLCs offered to him (like A1 and A2) would be on-chain, if Bob was routing these, then he would not have forwarded them on since they are not yet irrevocably committed. He thus won’t be able to claim the success path but that is fine since the funds for these did not come out of his balance. If Bob was the final destination for these, then he would be able to claim them via the success path. ⚙️ Step 6: Alice -\u003e Bob: update_add_htlc(A3) I want to really nail down the point that the commitment transactions can remain out of sync indefinitely and that Bob does not need to send commitment_signed just because Alice did. So, for the sake of the example, let’s say that Alice at this point sends yet another HTLC, A3, to Bob:\n⚙️ Step 7: Bob -\u003e Alice: commitment_signed Bob wants to irrevocably commit some of the HTLCs so that he can forward them on, so he finally sends Alice a commitment_signed of his own. This will include his signature for Alice’s staging-area commitment transaction along with all the signatures required from him for the second-level HTLC outputs.\n⚙️ Step 8: Alice -\u003e Bob: revoke_and_ack Just like Bob did previously, Alice responds to the commitment_signed with a revoke_and_ack in order to revoke her previous state. This also serves as an acknowledgement to Bob that Alice has received and committed to B1 and so Bob can now add B1 to his staging area commitment transaction.\nAllow me to clean that up real quick…\nMuch better.\nAt last, we have some irrevocably committed HTLCs! A1 and A2 have been irrevocably committed. B1 and A3, however, have not since they have not yet been committed to by both parties.\nLet’s quickly irrevocably commit B1 and A3.\n⚙️ Step 8: Alice -\u003e Bob: commitment_signed ⚙️ Step 9: Bob -\u003e Alice: revoke_and_ack ⚙️ Step 10: Bob -\u003e Alice: commitment_signed ⚙️ Step 11: Alice -\u003e Bob: revoke_and_ack Another clean-up:\nOk cool! Now all the HTLCs have been irrevocably committed.\nRemoving HTLCs You probably get the idea of adding HTLCs now. But how about removing them? HTLCs are removed if a payment succeeds or if it fails. Note that HTLC removal messages can only be sent by the peer who did not send the original update_add_htlc and that HTLC’s are only removable once they have been irrevocably committed to. Luckily for us, all the HTLCs have been irrevocably committed, and so we can start removing them now.\n⚙️ Step 12: Bob -\u003e Alice: update_fulfill_htlc(A2) In the best case scenario, an HTLC is removed because it is being fulfilled meaning that its pre-image is being passed back. This is done with the update_fulfilled_htlc message which looks as follows:\nIn our example, Bob sends Alice the update_fulfill_htlc message for HTLC A2. This also demonstrates that the HTLCs don’t need to be removed in the same order they were added.\nNotice that just like the updates for adding an HTLC, updates for removing an HTLC will also initially be pending on the receiver side until they have been acknowledged by a revoke_and_ack. So in our case, Alice removes A2 from her staging area transaction when she receives the update_fulfill_htlc (and allocates the HTLC amount to Bob’s output) but Bob does not yet remove the HTLC from his staging area transaction.\nUnlike other update messages, there is no need to wait for an HTLC removal to be irrevocably committed if you receive the pre-image for it. You can immediately send the pre-image upstream in order to claim any HTLCs there.\n⚙️ Step 13: Bob -\u003e Alice: update_fail_htlc(A1) HTLCs can also be removed due to payment failures such as HTLCs timing out or if there was some sort of routing failure such as a specific channel on the path no longer existing, a hop’s fee requirements not being met, a link not having sufficient balance etc. Such failures are communicated with the update_fail_htlc message:\nThe reason field is an encrypted blob for the sender of the payment in order to inform them of the failure reason.\nAfter Bob sends Alice the update_fail_htlc message for A1, the state looks as follows:\n⚙️ Step 14: Bob -\u003e Alice: update_fail_malformed_htlc(A3) The final message that can be used to remove an HTLC is the update_fail_malformed_htlc message:\nThis is sent back if any hop was unable to parse the onion_routing_packet it received in update_add_htlc. If Bob sends Alice this message for A3, then the state now looks as follows:\n⚙️ Step 15: Alice -\u003e Bob: update_fulfill_htlc(B1) Alice also initiates the removal of B1 by sending an update_fulfill_htlc to Bob.\nLet’s now clean-up the HTLC removals by irrevocably committing them. This will require a few commitment_signed-revoke_and_ack flows:\n⚙️ Step 16: Bob-\u003e Alice: commitment_signed ⚙️ Step 17: Alice -\u003e Bob: revoke_and_ack ⚙️ Step 18: Alice -\u003e Bob: commitment_signed ⚙️ Step 19: Bob -\u003e Alice: revoke_and_ack ⚙️ Step 20: Bob -\u003e Alice: commitment_signed ⚙️ Step 21: Alice -\u003e Bob: revoke_and_ack The two valid states now look nice and clean once again:\nUpdating fees There is one more update_* message that we need to cover and that is the update_fee message. This message is used to update the fee-rate that the peers should use when constructing their commitment transactions. The original fee-rate is decided in the open-channel flow but if the average mempool fee-rate increases, the channel funder might decide to update the fee of the commitment transactions so that they have a better chance of getting confirmed in a timely manner in a force close situation. It could also be that when the channel was opened, a very high fee-rate was chosen and perhaps a lower fee-rate would be desired.\nThis message follows similar rules to other update_* messages in that it must also be irrevocably committed before it takes effect. The only other extra rule that applies to this message is that only the channel funder may send this message.\nOne thing to note is that with anchor channels, the need to use the update_fee message is becoming less and less since nodes will be able to use CPFP on the force-close transaction if required.\nMessage Retransmission Something that you may have picked up on while walking through the add/remove HTLC flow is that explicit acknowledgements for the update_* messages is delayed until the commitment_signed/revoke_and_ack exchange. That is ok most of the time since we assume that the underlying transport between the two nodes (see Bolt 8) is ordered and reliable. However, if the connection needs to be re-established for some reason, there will be doubt regarding whether our peer has received the last message that we sent. This is where the channel_reestablish message comes in. Upon reconnection, before continuing with the normal operation flow, the peers will exchange this message to make sure they are on the same page and to determine which messages they possibly need to re-send to their peer.\nEach peer in the channel has their version of the commitment transaction and the two commitment transactions can be updated independently meaning that the number of times that one side’s commitment transaction state has been updated (through the commitment_signed and revoke_and_ack flow) could be completely different to that of the other side. The next_commitment_number field in the channel_reestablish message allows us to communicate with our peer the next commitment_signed that we expect to receive from them. This way, they will know if we have perhaps missed a commitment_signed from them that they previously sent before the disconnection. In other words, next_commitment_number tells the remote peer what we see our latest committed state to be. Similarly, next_revocation_number is the commitment number of the next revoke_and_ack that we expect to receive. In other words, this indicates to our peer which commitment number we think is their latest one. The your_last_per_commitment_secret is the last per-commitment secret received from the remote peer which will give the remote peer an idea of the state it has definitely revoked. my_current_per_commitment_point is the commitment point of the local party on its last commitment transaction signed by the remote peer (in other words, the commitment transaction that has not yet been revoked). There are a lot of checks that a node should do when receiving a channel_reestablish in order to make sure that all necessary updates are re-sent so that the channel can continue as normal. There are also some checks that ensure that nodes are not tricked into revoking a state that should not yet be revoked or tricked into broadcasting a state that has been revoked. If you are interested in the details around these checks, see bolt 2.\nNote that when a connection re-establish happens, both sides must remove any un-committed updates from their staging area. If we stick with the git analogy, they should hit git stash when a reconnection occurs. This means that both sides will need to re-transmit any update_* messages that were not yet committed on the other side’s commitment transaction.\nClosing a channel cooperatively Alice and Bob sure had some good times together but all good things must come to an end. Closing a channel in a cooperative way requires the two peers to decide on a final closing transaction that will spend from the funding transaction and will pay each of them their final channel balance immediately.\n⚙️ Step 22: Bob -\u003e Alice: shutdown Bob has decided that it is time to cut ties and sends Alice the shutdown message.\nThe shutdown message contains the scriptpubkey that Bob would like his final channel balance to be sent to in the closing transaction. Once Bob has sent this message, he may no longer send any new update_add_htlc messages. He may only send HTLC removal and update_fee messages. When Alice receives this message from Bob, she must respond with her own shutdown message and may also no longer send any new update_add_htlc messages. Alice and Bob now need to wait until all remaining HTLCs have been cleared from both commitment transactions. Since the closing transaction will spend from the funding transaction and explicitly looks different from the commitment transactions, I’ll re-introduce some of the details in to the state diagram:\nOnce all the HTLCs have been cleared, which in our example is already the case, they can start negotiating a fee to use for the final closing transaction. The funder of the channel must start this negotiation. Let’s assume that the funder of this channel was Alice.\n⚙️ Step 23: Alice -\u003e Bob: closing_signed Alice will first choose a fee-rate that she thinks is appropriate for the closing transaction. She will then use that fee-rate to complete the construction of the closing transaction and will sign it. She then sends the closing_signed message to Bob:\nThe fee_satoshis field tells Bob the fee in satoshis that Alice used to construct the first closing transaction proposal and the signature contains Alice’s signature for this proposal. She may optionally also include the min_fee_satoshis and max_fee_satoshis fields in order to let Bob know that if he disagrees with her proposed fee_satoshis, then he may send a counterproposal as long as his counterproposal lies between the provided minimum and maximum values.\nAt this point, the channel state looks as follows:\nThere are two valid commitment transactions that can be signed at any time by each party to perform a force close, and there is one closing transaction proposal that uses a fee-rate of x sats-per-byte. This closing transaction currently only has Alice’s signature and so is not yet valid.\nIf at this point, Bob is happy with Alice’s proposal, he could go ahead and sign the closing transaction using the fee-rate proposed by Alice and could broadcast it and that would be the end of it. But for the sake of the example, let’s say that Bob isn’t quite happy yet.\n⚙️ Step 24: Bob -\u003e Alice: closing_signed Bob may decide that the fee rate that Alice used is too low. So he sends a counterproposal with a new fee rate, y sats-per-byte, along with his signature for this counterproposal.\n⚙️ Step 25: Alice -\u003e Bob: closing_signed If Alice is happy with Bob’s counterproposal, then she signs the closing transaction using the fee-rate suggested by Bob. She may then broadcast the transaction and call it a day. However, it is recommended in the spec that Alice send one more closing_signed message to Bob but this time with the fee_satoshis field set to y sats-per-byte along with her signature for the transaction. Both parties will now have both signature required in order to broadcast the final closing transaction that uses the y sats-per-byte fee rate.\nEither or both parties may now broadcast the closing transaction to the Bitcoin network. Eventually it will be confirmed, and the channel will officially be closed.\nIf this channel was a public channel, then any node in the network that had this channel in their routing graph will be able to see that the channel’s funding output has been spent and so will remove the channel from their graph at this point.\nThe beauty of the channel is that Alice and Bob could have sent millions of HTLCs back and forth throughout the lifetime of the channel and in the end, all that showed up on-chain was the opening and closing transaction.\nAlice and Bob lived happily ever after.\nThanks for reading! As always, if anything is unclear or incorrect, feel free to leave a comment down below.\n",
  "wordCount" : "4309",
  "inLanguage": "en",
  "image":"https://www.ellemouton.com/normalChanOp/cover.png","datePublished": "2023-06-14T00:00:00Z",
  "dateModified": "2023-06-14T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": {"email":"elle.mouton@gmail.com","name":"Elle Mouton"}
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.ellemouton.com/posts/normal-operation-pre-taproot/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Elle Mouton",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.ellemouton.com/favicon.ico"
    }
  }
}
</script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
            delimiters: [
                {left: '\\[', right: '\\]', display: true},   
                {left: '$$', right: '$$', display: true},     
                {left: '\\(', right: '\\)', display: false},  
                {left: '$', right: '$', display: false},      
            ],
            throwOnError : false
        });
    });
</script>
    
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://www.ellemouton.com" accesskey="h" title="Elle Mouton (Alt + H)">Elle Mouton</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://www.ellemouton.com/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://www.ellemouton.com/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Normal operation and closure of a pre-taproot LN channel
    </h1>
    <div class="post-meta"><span title='2023-06-14 00:00:00 +0000 UTC'>June 14, 2023</span>&nbsp;·&nbsp;map[email:elle.mouton@gmail.com name:Elle Mouton]

</div>
  </header> 
<figure class="entry-cover"><img loading="lazy" src="https://www.ellemouton.com/normalChanOp/cover.png" alt="">
        
</figure><div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#overview" aria-label="Overview">Overview</a></li>
                <li>
                    <a href="#preliminaries" aria-label="Preliminaries">Preliminaries</a></li>
                <li>
                    <a href="#normal-channel-operation" aria-label="Normal Channel Operation">Normal Channel Operation</a><ul>
                        
                <li>
                    <a href="#setting-the-scene" aria-label="Setting the scene">Setting the scene</a></li>
                <li>
                    <a href="#adding-an-htlc" aria-label="Adding an HTLC">Adding an HTLC</a><ul>
                        
                <li>
                    <a href="#-step-1-alice---bob-update_add_htlca1" aria-label="⚙️ Step 1: Alice -&amp;gt; Bob: update_add_htlc(A1)">⚙️ Step 1: Alice -&gt; Bob: <code>update_add_htlc(A1)</code></a></li>
                <li>
                    <a href="#-step-2-alice---bob-update_add_htlca2" aria-label="⚙️ Step 2: Alice -&amp;gt; Bob: update_add_htlc(A2)">⚙️ Step 2: Alice -&gt; Bob: <code>update_add_htlc(A2)</code></a></li>
                <li>
                    <a href="#-step-3-bob---alice-update_add_htlcb1" aria-label="⚙️ Step 3: Bob -&amp;gt; Alice update_add_htlc(B1)">⚙️ Step 3: Bob -&gt; Alice <code>update_add_htlc(B1)</code></a></li></ul>
                </li>
                <li>
                    <a href="#committing-to-the-current-state" aria-label="Committing to the current state">Committing to the current state</a><ul>
                        
                <li>
                    <a href="#-step-4-alice---bob-commitment_signed" aria-label="⚙️ Step 4: Alice -&amp;gt; Bob: commitment_signed">⚙️ Step 4: Alice -&gt; Bob: <code>commitment_signed</code></a></li>
                <li>
                    <a href="#-step-5-bob---alice-revoke_and_ack" aria-label="⚙️ Step 5: Bob -&amp;gt; Alice: revoke_and_ack">⚙️ Step 5: Bob -&gt; Alice: <code>revoke_and_ack</code></a></li>
                <li>
                    <a href="#-step-6-alice---bob-update_add_htlca3" aria-label="⚙️ Step 6: Alice -&amp;gt; Bob: update_add_htlc(A3)">⚙️ Step 6: Alice -&gt; Bob: <code>update_add_htlc(A3)</code></a></li>
                <li>
                    <a href="#-step-7-bob---alice-commitment_signed" aria-label="⚙️ Step 7: Bob -&amp;gt; Alice: commitment_signed">⚙️ Step 7: Bob -&gt; Alice: <code>commitment_signed</code></a></li>
                <li>
                    <a href="#-step-8-alice---bob-revoke_and_ack" aria-label="⚙️ Step 8: Alice -&amp;gt; Bob: revoke_and_ack">⚙️ Step 8: Alice -&gt; Bob: <code>revoke_and_ack</code></a></li>
                <li>
                    <a href="#-step-8-alice---bob-commitment_signed" aria-label="⚙️ Step 8: Alice -&amp;gt; Bob: commitment_signed">⚙️ Step 8: Alice -&gt; Bob: <code>commitment_signed</code></a></li>
                <li>
                    <a href="#-step-9-bob---alice-revoke_and_ack" aria-label="⚙️ Step 9: Bob -&amp;gt; Alice: revoke_and_ack">⚙️ Step 9: Bob -&gt; Alice: <code>revoke_and_ack</code></a></li>
                <li>
                    <a href="#-step-10-bob---alice-commitment_signed" aria-label="⚙️ Step 10: Bob -&amp;gt; Alice: commitment_signed">⚙️ Step 10: Bob -&gt; Alice: <code>commitment_signed</code></a></li>
                <li>
                    <a href="#-step-11-alice---bob-revoke_and_ack" aria-label="⚙️ Step 11: Alice -&amp;gt; Bob: revoke_and_ack">⚙️ Step 11: Alice -&gt; Bob: <code>revoke_and_ack</code></a></li>
                <li>
                    <a href="#removing-htlcs" aria-label="Removing HTLCs">Removing HTLCs</a></li>
                <li>
                    <a href="#-step-12-bob---alice-update_fulfill_htlca2" aria-label="⚙️ Step 12: Bob -&amp;gt; Alice: update_fulfill_htlc(A2)">⚙️ Step 12: Bob -&gt; Alice: <code>update_fulfill_htlc(A2)</code></a></li>
                <li>
                    <a href="#-step-13-bob---alice-update_fail_htlca1" aria-label="⚙️ Step 13: Bob -&amp;gt; Alice: update_fail_htlc(A1)">⚙️ Step 13: Bob -&gt; Alice: <code>update_fail_htlc(A1)</code></a></li>
                <li>
                    <a href="#-step-14-bob---alice-update_fail_malformed_htlca3" aria-label="⚙️ Step 14: Bob -&amp;gt; Alice: update_fail_malformed_htlc(A3)">⚙️ Step 14: Bob -&gt; Alice: <code>update_fail_malformed_htlc(A3)</code></a></li>
                <li>
                    <a href="#-step-15-alice---bob-update_fulfill_htlcb1" aria-label="⚙️ Step 15: Alice -&amp;gt; Bob: update_fulfill_htlc(B1)">⚙️ Step 15: Alice -&gt; Bob: <code>update_fulfill_htlc(B1)</code></a></li>
                <li>
                    <a href="#-step-16-bob--alice-commitment_signed" aria-label="⚙️ Step 16: Bob-&amp;gt; Alice: commitment_signed">⚙️ Step 16: Bob-&gt; Alice: <code>commitment_signed</code></a></li>
                <li>
                    <a href="#-step-17-alice---bob-revoke_and_ack" aria-label="⚙️ Step 17: Alice -&amp;gt; Bob: revoke_and_ack">⚙️ Step 17: Alice -&gt; Bob: <code>revoke_and_ack</code></a></li>
                <li>
                    <a href="#-step-18-alice---bob-commitment_signed" aria-label="⚙️ Step 18: Alice -&amp;gt; Bob: commitment_signed">⚙️ Step 18: Alice -&gt; Bob: <code>commitment_signed</code></a></li>
                <li>
                    <a href="#-step-19-bob---alice-revoke_and_ack" aria-label="⚙️ Step 19: Bob -&amp;gt; Alice: revoke_and_ack">⚙️ Step 19: Bob -&gt; Alice: <code>revoke_and_ack</code></a></li>
                <li>
                    <a href="#-step-20-bob---alice-commitment_signed" aria-label="⚙️ Step 20: Bob -&amp;gt; Alice: commitment_signed">⚙️ Step 20: Bob -&gt; Alice: <code>commitment_signed</code></a></li>
                <li>
                    <a href="#-step-21-alice---bob-revoke_and_ack" aria-label="⚙️ Step 21: Alice -&amp;gt; Bob: revoke_and_ack">⚙️ Step 21: Alice -&gt; Bob: <code>revoke_and_ack</code></a></li></ul>
                </li>
                <li>
                    <a href="#updating-fees" aria-label="Updating fees">Updating fees</a></li>
                <li>
                    <a href="#message-retransmission" aria-label="Message Retransmission">Message Retransmission</a></li></ul>
                </li>
                <li>
                    <a href="#closing-a-channel-cooperatively" aria-label="Closing a channel cooperatively">Closing a channel cooperatively</a><ul>
                        <ul>
                        
                <li>
                    <a href="#-step-22-bob---alice-shutdown" aria-label="⚙️ Step 22: Bob -&amp;gt; Alice: shutdown">⚙️ Step 22: Bob -&gt; Alice: <code>shutdown</code></a></li>
                <li>
                    <a href="#-step-23-alice---bob-closing_signed" aria-label="⚙️ Step 23: Alice -&amp;gt; Bob: closing_signed">⚙️ Step 23: Alice -&gt; Bob: <code>closing_signed</code></a></li>
                <li>
                    <a href="#-step-24-bob---alice-closing_signed" aria-label="⚙️ Step 24: Bob -&amp;gt; Alice: closing_signed">⚙️ Step 24: Bob -&gt; Alice: <code>closing_signed</code></a></li>
                <li>
                    <a href="#-step-25-alice---bob-closing_signed" aria-label="⚙️ Step 25: Alice -&amp;gt; Bob: closing_signed">⚙️ Step 25: Alice -&gt; Bob: <code>closing_signed</code></a>
                </li>
            </ul>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>I’ve <a href="../../posts/open_channel_pre_taproot">previously written</a> in depth about how Lightning channels
are opened, but I’ve never gone into the details of the normal operations and
closures of channels. Since I promised in my <a href="../../posts/taproot-chan-txs">previous post</a> about
Taproot channel transactions that I would write a follow-up explaining how all
the channel messages need to be updated in order to support the new MuSig2
signing required by Taproot channels, I think now is the time to finally dive
into the normal channel operations and closures so that the follow-up post on
how Taproot channels affect these operations is easier to parse.</p>
<h1 id="overview">Overview<a hidden class="anchor" aria-hidden="true" href="#overview">#</a></h1>
<p>In this blog post, I will talk about the normal operations of a channel. This
involves understanding how HTLCs are added to a channel and how channel peers
commit to a new state including these HTLCs. Then I will cover how a channel’s
normal flow is re-established after a disconnection and finally, the cooperative
channel closure flow will be covered. All of these topics are covered in
<a href="https://github.com/lightning/bolts/blob/master/02-peer-protocol.md">Bolt 2</a>, but I thought a diagram or two could help with understanding.
I plan on doing all of this with a long-running example.</p>
<h1 id="preliminaries">Preliminaries<a hidden class="anchor" aria-hidden="true" href="#preliminaries">#</a></h1>
<p>Here are a few links that cover some preliminaries that might be useful for
understanding this blog post:</p>
<ul>
<li>Why channel peers have an asymmetric state and how they go about updating this
state in a trust-less way: <a href="../../posts/updating-state">Updating State</a>.</li>
<li>What HTLC outputs look like on a commitment transaction: <a href="../../posts/htlc-deep-dive">HTLC
deep-dive</a>.</li>
<li>How two nodes go about opening a channel: <a href="../../posts/open_channel_pre_taproot">Opening and announcing a
pre-taproot LN channel</a>.</li>
</ul>
<h1 id="normal-channel-operation">Normal Channel Operation<a hidden class="anchor" aria-hidden="true" href="#normal-channel-operation">#</a></h1>
<h2 id="setting-the-scene">Setting the scene<a hidden class="anchor" aria-hidden="true" href="#setting-the-scene">#</a></h2>
<p>Alice and Bob (hello old friends!) have successfully opened their channel. They
have both seen that the funding transaction has confirmed, and they have
exchanged the <code>channel_ready</code> message with each other to indicate that they are
ready to use the channel. The state of their asymmetric commitment transactions
currently look as follows:</p>
<p><img loading="lazy" src="/normalChanOp/1-initial.png#center" alt=""  />
</p>
<p>Both commitment transactions spend the 2-of-2 multi-sig funding transaction
output. Spending from this output requires a signature from both parties. The
signatures are represented by the two boxes at the top of the commitment
transactions. You can see from the diagram that Alice’s commitment transaction
has a signature from Bob represented by the blue box (say it with me: “Bob is
blue!”) and Bob has a signature from Alice for his commitment transaction
represented by the green box (“Alice is green” doesn’t have quite the same ring
to it). Each commitment transaction also has the <code>to_local</code> and <code>to_remote</code>
outputs which pay the respective parties their current channel balance. Both
Alice and Bob have the ability to sign their own commitment transaction at any
time and broadcast it to the Bitcoin network. This would be a force close.</p>
<p>For the sake of making the next few diagrams in this article a bit simpler, I
am going to ignore the funding transaction along with the <code>to_local</code> and
<code>to_remote</code> outputs for a while since our initial focus is going to be on adding
and removing HTLC outputs. So the above diagram can instead be represented as
follows:</p>
<p><img loading="lazy" src="/normalChanOp/2-simplified.png#center" alt=""  />
</p>
<p>A red coloured commitment transaction, as shown below, represents past, revoked
commitment transactions. If Alice or Bob were to sign and broadcast one of their
older revoked commitment transactions then the other side would be able to sweep
all their funds. So these revoked transactions can effectively be considered
invalid. The yellow commitment transactions represent the latest, valid set of
commitment transactions. These are the commitment transactions that would be
broadcast in a force close. Then finally, each side has what can be thought of
as a “staging area” where changes to the commitment transaction can be proposed.
Later on, either side can decide when it wants its counterparty to commit to the
changes in their staging commitment transaction. For those of you who love a
good analogy - this is very much like a git workflow: past commits are out of
date, but they tell a nice story of what has happened, your latest committed
changes represent the current state of your project and any changes that are not
yet committed are in staging.</p>
<p><img loading="lazy" src="/normalChanOp/3-legend.png#center" alt=""  />
</p>
<h2 id="adding-an-htlc">Adding an HTLC<a hidden class="anchor" aria-hidden="true" href="#adding-an-htlc">#</a></h2>
<p>When either Alice or Bob want to send a payment across the channel in question
(which would happen if either of them wanted to send a payment themselves or if
they are routing another node’s payment) then they would need to propose the
inclusion of the HTLC to their channel peer. This is done with the
<code>update_add_htlc</code> message:</p>
<p><img loading="lazy" src="/normalChanOp/update_add_htlc.png#center" alt=""  />
</p>
<p>The <code>channel_id</code> is used to communicate which channel this change should take
place on, the <code>id</code> is an always-incrementing identifier for this proposed
change from the sender. The <code>amount_msat</code> is the amount that should be attached
to the HTLC output, the <code>cltv_expiry</code> is the block height that the HTLC should
expire at and finally the <code>onion_routing_packet</code> and optional <code>blinding_point</code>
both contain data that the recipient will use to determine where next to send
the payment.</p>
<p>Something that definitely took me a while to wrap my head around is the fact
that the sender of this message does not put this update in their own staging
area commitment transaction yet. This is because the update is still &ldquo;pending
on the receiver&rdquo; because the sender has not yet received any acknowledgement
from receiver for the new update. This is to allow for the case where one peer
sends an update and then immediately receives a <code>commitment_signed</code> message
(more details on this later). In that case, there should be no ambiguity around
which updates are included in the transaction being signed. Hopefully this makes
more sense as we work through the example.</p>
<h3 id="-step-1-alice---bob-update_add_htlca1">⚙️ Step 1: Alice -&gt; Bob: <code>update_add_htlc(A1)</code><a hidden class="anchor" aria-hidden="true" href="#-step-1-alice---bob-update_add_htlca1">#</a></h3>
<p>Ok so let’s say that Alice sends Bob an <code>update_add_htlc</code>. Let’s call this
HTLC <code>A1</code> since it is the first one that Alice (<code>A</code>) is sending to Bob. If Bob
is happy with all the fields in the message, then he adds the HTLC to his
staging area commitment transaction and Alice marks the HTLC as pending on
Bob&rsquo;s side but does not yet add it to her staging commitment transaction:</p>
<p><img loading="lazy" src="/normalChanOp/4-add_a1.png#center" alt=""  />
</p>
<p>Note that neither side has actually committed to this HTLC and so if Bob is a
routing node for this payment, he should not yet send <code>update_add_HTLC</code> to the
next hop in the route until <code>A1</code> has been <em>irrevocably</em> committed. An HTLC
addition or removal is only considered irrevocably committed once both
parties in the channel have committed to the commitment transaction with or
without it respectively.</p>
<p>Something that the more simplified diagram fails to show is that Alice&rsquo;s main
output in Bob&rsquo;s staging commitment transaction (ie, the <code>to_remote</code> output)
will now have the value of the added HTLC subtracted (along with the fees to
cover the extra output). If the HTLC ends up succeeding then this amount will be
added to Bob&rsquo;s output and if it ends up failing, then it will be re-added to
Alice&rsquo;s output.</p>
<h3 id="-step-2-alice---bob-update_add_htlca2">⚙️ Step 2: Alice -&gt; Bob: <code>update_add_htlc(A2)</code><a hidden class="anchor" aria-hidden="true" href="#-step-2-alice---bob-update_add_htlca2">#</a></h3>
<p>Even if they have not committed to HTLC <code>A1</code> yet, that does not stop them from
adding more changes to the staging area. So Alice is more than welcome to
propose a new HTLC, <code>A2</code>, to Bob:</p>
<p><img loading="lazy" src="/normalChanOp/5-add_a2.png#center" alt=""  />
</p>
<h3 id="-step-3-bob---alice-update_add_htlcb1">⚙️ Step 3: Bob -&gt; Alice <code>update_add_htlc(B1)</code><a hidden class="anchor" aria-hidden="true" href="#-step-3-bob---alice-update_add_htlcb1">#</a></h3>
<p>Similarly, Bob can suggest a change <code>B1</code> to Alice:</p>
<p><img loading="lazy" src="/normalChanOp/6-add_b1.png#center" alt=""  />
</p>
<h2 id="committing-to-the-current-state">Committing to the current state<a hidden class="anchor" aria-hidden="true" href="#committing-to-the-current-state">#</a></h2>
<p>At some point, one of the peers will want to make sure that the other peer has
committed to the latest set of changes and revoke the previous valid state. This
is done by sending the <code>commitment_signed</code> message:</p>
<p><img loading="lazy" src="/normalChanOp/commitment_signed.png#center" alt=""  />
</p>
<p>The <code>channel_id</code> once again refers to the channel in question. The <code>signature</code>
is the sender&rsquo;s signature for the remote party’s staging area commitment
transaction. <code>num_htlcs</code> refers to the number of HTLCs that the sender expects
to be on the remote commitment transaction and this is then followed by
<code>htlc_signatures</code> which is an array of <code>num_hltcs</code> signatures which are the
sender’s signatures for each of the second-level HTLC transactions that the
remote party would need to broadcast if they were ever to force close the
channel. If you need a reminder about why the second-level HTLC transactions are
needed, give this <a href="../../posts/htlc-deep-dive">post</a> a read.</p>
<h3 id="-step-4-alice---bob-commitment_signed">⚙️ Step 4: Alice -&gt; Bob: <code>commitment_signed</code><a hidden class="anchor" aria-hidden="true" href="#-step-4-alice---bob-commitment_signed">#</a></h3>
<p>Let’s say that Alice sends this message to Bob. Bob will now have all the
required signatures from Alice to broadcast his staging-area commitment
transaction:</p>
<p><img loading="lazy" src="/normalChanOp/7-commit_sign_1.png#center" alt=""  />
</p>
<p>Notice that Alice knew that her signature would need to cover the <code>A1</code> and <code>A2</code>
HTLCs. This is fine because the <a href="https://github.com/lightning/bolts/blob/master/08-transport.md">underlying transport</a> is guaranteed to
be reliable and ordered meaning that if Bob was to receive Alice&rsquo;s
<code>commitment_signed</code> message then it means that he definitely received her
<code>update_add_htlc</code> messages for <code>A1</code> and <code>A2</code>. Alice and Bob both know that the
signature should not cover the <code>B1</code> HTLC since Alice has not sent an
acknowledgement for it yet.</p>
<p>Another thing to notice is that Bob now actually has two valid commitment
transactions since he has not yet revoked his previous state. He is, however,
incentivised at this point to revoke his previous commitment transaction since
the HTLCs on the new state are either:</p>
<ul>
<li>Payments to Bob himself meaning that he gains from committing to the new
state. If he doesn’t commit to the new state, then Alice won&rsquo;t either and so
there would still exist a version of a commitment transaction that does not
pay Bob his incoming funds.</li>
<li>Similarly to the above point, if Bob is routing a payment, then he is also
incentivised to try to get the HTLC irrevocably committed since he would earn
routing fees if the payment succeeds.</li>
<li>Finally, if Bob is making the payment himself, then the first state would in
fact be more desirable to him since he strictly has less funds in the second
state. However, the merchant that Bob is making the payment to won&rsquo;t release
the goods being purchased unless funds come through which won&rsquo;t happen if
Alice does not pass on the HTLC which she won&rsquo;t do unless it has been
irrevocably committed to. So again, Bob is incentivised to revoke his previous
state.</li>
</ul>
<h3 id="-step-5-bob---alice-revoke_and_ack">⚙️ Step 5: Bob -&gt; Alice: <code>revoke_and_ack</code><a hidden class="anchor" aria-hidden="true" href="#-step-5-bob---alice-revoke_and_ack">#</a></h3>
<p>In response to Alice’s <code>commitment_signed</code>, Bob sends the <code>revoke_and_ack</code>
message:</p>
<p><img loading="lazy" src="/normalChanOp/revoke_and_ack.png#center" alt=""  />
</p>
<p>The <code>per_commitment_secret</code> provides Alice with the information she needs in
order to be able to spend any revocation path on Bob’s previously valid state.
See <a href="../../posts/revocation">this</a> post for more details about how revocation works.
The <code>next_per_commitment_point</code> gives Alice the information she needs in order
to derive the revocation public key that will be used in Bob’s next commitment
transaction. Once Alice receives this message, Bob’s previous commitment
transaction has successfully been revoked. Note that this message explicitly
acknowledges the <code>commitment_signed</code> message sent by Alice and by extension,
since messages delivery is reliable and ordered, it also implicitly acknowledges
the <code>update_add_htlc</code> messages that Alice sent for <code>A1</code> and <code>A2</code>. Alice can
therefore finally add <code>A1</code> and <code>A2</code> to her staging area commitment transaction
since they are no longer pending on Bob&rsquo;s side:</p>
<p><img loading="lazy" src="/normalChanOp/8-revoke_1.png#center" alt=""  />
</p>
<p>Let’s clean up the diagram a bit…</p>
<p><img loading="lazy" src="/normalChanOp/9-clean_up_1.png#center" alt=""  />
</p>
<p>That’s better.</p>
<p>From the above diagram, notice that Alice&rsquo;s and Bob’s latest commitment
transactions are actually out of sync. This is fine since none of the updates
have been irrevocably committed yet. That might seem hard to believe since the
commitment transactions look so different so let’s walk through the consequences
of either of these transactions ending up on-chain from the perspective of both
sides.</p>
<ul>
<li>
<p>From Alice’s perspective:</p>
<ul>
<li>if her commitment transaction is broadcast, she gets back her original
<code>to_local</code> amount.</li>
<li>if Bob’s commitment transaction is broadcast, then Alice&rsquo;s offered HTLCs
(such as <code>A1</code> and <code>A2</code>) will be on-chain. For offered HTLCs, Alice is
sending sats <em>out</em> meaning that her <code>to_local</code> would be lower. But, if
Bob was a router node for these HTLCs then he would not have forwarded
them as they are not yet irrevocably committed meaning that he won&rsquo;t
receive the pre-images required to claim these HTLCs and Alice would be
able to get her funds back via the timeout path. If Bob was the recipient
of these HTLCs, then he would be able to produce the pre-image to claim
the HTLCs, but then Alice would see the pre-image on-chain and would be
able to claim the incoming HTLCs from their incoming channel and would
thus have earned routing fees.</li>
</ul>
</li>
<li>
<p>From Bob’s perspective (very similar to the logic for Alice):</p>
<ul>
<li>if Alice’s commitment transaction is broadcast, Bob gets back his funds via
the <code>to_remote</code> output.</li>
<li>If Bob had to force close via his commitment transaction, then HTLCs offered
to him (like <code>A1</code> and <code>A2</code>) would be on-chain, if Bob was routing these,
then he would not have forwarded them on since they are not yet irrevocably
committed. He thus won&rsquo;t be able to claim the success path but that is fine
since the funds for these did not come out of his balance. If Bob was the
final destination for these, then he would be able to claim them via the
success path.</li>
</ul>
</li>
</ul>
<h3 id="-step-6-alice---bob-update_add_htlca3">⚙️ Step 6: Alice -&gt; Bob: <code>update_add_htlc(A3)</code><a hidden class="anchor" aria-hidden="true" href="#-step-6-alice---bob-update_add_htlca3">#</a></h3>
<p>I want to really nail down the point that the commitment transactions can remain
out of sync indefinitely and that Bob does not need to send <code>commitment_signed</code>
just because Alice did. So, for the sake of the example, let’s say that Alice at
this point sends yet another HTLC, <code>A3</code>, to Bob:</p>
<p><img loading="lazy" src="/normalChanOp/10-add_a3.png#center" alt=""  />
</p>
<h3 id="-step-7-bob---alice-commitment_signed">⚙️ Step 7: Bob -&gt; Alice: <code>commitment_signed</code><a hidden class="anchor" aria-hidden="true" href="#-step-7-bob---alice-commitment_signed">#</a></h3>
<p>Bob wants to irrevocably commit some of the HTLCs so that he can forward them
on, so he finally sends Alice a <code>commitment_signed</code> of his own. This will
include his signature for Alice’s staging-area commitment transaction along with
all the signatures required from him for the second-level HTLC outputs.</p>
<p><img loading="lazy" src="/normalChanOp/11-commit_sign_2.png#center" alt=""  />
</p>
<h3 id="-step-8-alice---bob-revoke_and_ack">⚙️ Step 8: Alice -&gt; Bob: <code>revoke_and_ack</code><a hidden class="anchor" aria-hidden="true" href="#-step-8-alice---bob-revoke_and_ack">#</a></h3>
<p>Just like Bob did previously, Alice responds to the <code>commitment_signed</code> with
a <code>revoke_and_ack</code> in order to revoke her previous state. This also serves as
an acknowledgement to Bob that Alice has received and committed to <code>B1</code> and so
Bob can now add <code>B1</code> to his staging area commitment transaction.</p>
<p><img loading="lazy" src="/normalChanOp/12-revoke_2.png#center" alt=""  />
</p>
<p>Allow me to clean that up real quick…</p>
<p><img loading="lazy" src="/normalChanOp/13-clean_up_2.png#center" alt=""  />
</p>
<p>Much better.</p>
<p>At last, we have some irrevocably committed HTLCs! <code>A1</code> and <code>A2</code> have
been irrevocably committed. <code>B1</code> and <code>A3</code>, however, have not since they have not
yet been committed to by both parties.</p>
<p>Let&rsquo;s quickly irrevocably commit <code>B1</code> and <code>A3</code>.</p>
<h3 id="-step-8-alice---bob-commitment_signed">⚙️ Step 8: Alice -&gt; Bob: <code>commitment_signed</code><a hidden class="anchor" aria-hidden="true" href="#-step-8-alice---bob-commitment_signed">#</a></h3>
<p><img loading="lazy" src="/normalChanOp/14-commit_sign_3.png#center" alt=""  />
</p>
<h3 id="-step-9-bob---alice-revoke_and_ack">⚙️ Step 9: Bob -&gt; Alice: <code>revoke_and_ack</code><a hidden class="anchor" aria-hidden="true" href="#-step-9-bob---alice-revoke_and_ack">#</a></h3>
<p><img loading="lazy" src="/normalChanOp/15-revoke_3.png#center" alt=""  />
</p>
<h3 id="-step-10-bob---alice-commitment_signed">⚙️ Step 10: Bob -&gt; Alice: <code>commitment_signed</code><a hidden class="anchor" aria-hidden="true" href="#-step-10-bob---alice-commitment_signed">#</a></h3>
<p><img loading="lazy" src="/normalChanOp/17-commit_sign_4.png#center" alt=""  />
</p>
<h3 id="-step-11-alice---bob-revoke_and_ack">⚙️ Step 11: Alice -&gt; Bob: <code>revoke_and_ack</code><a hidden class="anchor" aria-hidden="true" href="#-step-11-alice---bob-revoke_and_ack">#</a></h3>
<p><img loading="lazy" src="/normalChanOp/18-revoke_4.png#center" alt=""  />
</p>
<p>Another clean-up:</p>
<p><img loading="lazy" src="/normalChanOp/19-clean_up_4.png#center" alt=""  />
</p>
<p>Ok cool! Now all the HTLCs have been irrevocably committed.</p>
<h3 id="removing-htlcs">Removing HTLCs<a hidden class="anchor" aria-hidden="true" href="#removing-htlcs">#</a></h3>
<p>You probably get the idea of adding HTLCs now. But how about removing them?
HTLCs are removed if a payment succeeds or if it fails. Note that HTLC removal
messages can only be sent by the peer who did not send the original
<code>update_add_htlc</code> and that HTLC’s are only removable once they have been
irrevocably committed to. Luckily for us, all the HTLCs have been irrevocably
committed, and so we can start removing them now.</p>
<h3 id="-step-12-bob---alice-update_fulfill_htlca2">⚙️ Step 12: Bob -&gt; Alice: <code>update_fulfill_htlc(A2)</code><a hidden class="anchor" aria-hidden="true" href="#-step-12-bob---alice-update_fulfill_htlca2">#</a></h3>
<p>In the best case scenario, an HTLC is removed because it is being fulfilled
meaning that its pre-image is being passed back. This is done with the
<code>update_fulfilled_htlc</code> message which looks as follows:</p>
<p><img loading="lazy" src="/normalChanOp/update_fulfill_htlc.png#center" alt=""  />
</p>
<p>In our example, Bob sends Alice the <code>update_fulfill_htlc</code> message for HTLC <code>A2</code>.
This also demonstrates that the HTLCs don’t need to be removed in the same order
they were added.</p>
<p><img loading="lazy" src="/normalChanOp/20-fulfill_a2.png#center" alt=""  />
</p>
<p>Notice that just like the updates for adding an HTLC, updates for removing an
HTLC will also initially be pending on the receiver side until they have been
acknowledged by a <code>revoke_and_ack</code>. So in our case, Alice removes <code>A2</code> from her
staging area transaction when she receives the <code>update_fulfill_htlc</code> (and
allocates the HTLC amount to Bob&rsquo;s output) but Bob does not yet remove the HTLC
from his staging area transaction.</p>
<p>Unlike other update messages, there is no need to wait for an HTLC removal to be
irrevocably committed if you receive the pre-image for it. You can immediately
send the pre-image upstream in order to claim any HTLCs there.</p>
<h3 id="-step-13-bob---alice-update_fail_htlca1">⚙️ Step 13: Bob -&gt; Alice: <code>update_fail_htlc(A1)</code><a hidden class="anchor" aria-hidden="true" href="#-step-13-bob---alice-update_fail_htlca1">#</a></h3>
<p>HTLCs can also be removed due to payment failures such as HTLCs timing out or if
there was some sort of routing failure such as a specific channel on the path
no longer existing, a hop’s fee requirements not being met, a link not having
sufficient balance etc. Such failures are communicated with the
<code>update_fail_htlc</code> message:</p>
<p><img loading="lazy" src="/normalChanOp/update_fail_htlc.png#center" alt=""  />
</p>
<p>The <code>reason</code> field is an encrypted blob for the sender of the payment in order
to inform them of the failure reason.</p>
<p>After Bob sends Alice the <code>update_fail_htlc</code> message for <code>A1</code>, the state looks
as follows:</p>
<p><img loading="lazy" src="/normalChanOp/21-fail_a1.png#center" alt=""  />
</p>
<h3 id="-step-14-bob---alice-update_fail_malformed_htlca3">⚙️ Step 14: Bob -&gt; Alice: <code>update_fail_malformed_htlc(A3)</code><a hidden class="anchor" aria-hidden="true" href="#-step-14-bob---alice-update_fail_malformed_htlca3">#</a></h3>
<p>The final message that can be used to remove an HTLC is the
<code>update_fail_malformed_htlc</code> message:</p>
<p><img loading="lazy" src="/normalChanOp/update_fail_malformed_htlc.png#center" alt=""  />
</p>
<p>This is sent back if any hop was unable to parse the <code>onion_routing_packet</code> it
received in <code>update_add_htlc</code>. If Bob sends Alice this message for <code>A3</code>, then
the state now looks as follows:</p>
<p><img loading="lazy" src="/normalChanOp/22-fail_a3.png#center" alt=""  />
</p>
<h3 id="-step-15-alice---bob-update_fulfill_htlcb1">⚙️ Step 15: Alice -&gt; Bob: <code>update_fulfill_htlc(B1)</code><a hidden class="anchor" aria-hidden="true" href="#-step-15-alice---bob-update_fulfill_htlcb1">#</a></h3>
<p>Alice also initiates the removal of <code>B1</code> by sending an <code>update_fulfill_htlc</code>
to Bob.</p>
<p><img loading="lazy" src="/normalChanOp/23-fulfill_b1.png#center" alt=""  />
</p>
<p>Let’s now clean-up the HTLC removals by irrevocably committing them. This will
require a few <code>commitment_signed</code>-<code>revoke_and_ack</code> flows:</p>
<h3 id="-step-16-bob--alice-commitment_signed">⚙️ Step 16: Bob-&gt; Alice: <code>commitment_signed</code><a hidden class="anchor" aria-hidden="true" href="#-step-16-bob--alice-commitment_signed">#</a></h3>
<p><img loading="lazy" src="/normalChanOp/24-commit_sign_5.png#center" alt=""  />
</p>
<h3 id="-step-17-alice---bob-revoke_and_ack">⚙️ Step 17: Alice -&gt; Bob: <code>revoke_and_ack</code><a hidden class="anchor" aria-hidden="true" href="#-step-17-alice---bob-revoke_and_ack">#</a></h3>
<p><img loading="lazy" src="/normalChanOp/25-revoke_5.png#center" alt=""  />
</p>
<h3 id="-step-18-alice---bob-commitment_signed">⚙️ Step 18: Alice -&gt; Bob: <code>commitment_signed</code><a hidden class="anchor" aria-hidden="true" href="#-step-18-alice---bob-commitment_signed">#</a></h3>
<p><img loading="lazy" src="/normalChanOp/26-commit_sig_6.png#center" alt=""  />
</p>
<h3 id="-step-19-bob---alice-revoke_and_ack">⚙️ Step 19: Bob -&gt; Alice: <code>revoke_and_ack</code><a hidden class="anchor" aria-hidden="true" href="#-step-19-bob---alice-revoke_and_ack">#</a></h3>
<p><img loading="lazy" src="/normalChanOp/27-revoke_6.png#center" alt=""  />
</p>
<h3 id="-step-20-bob---alice-commitment_signed">⚙️ Step 20: Bob -&gt; Alice: <code>commitment_signed</code><a hidden class="anchor" aria-hidden="true" href="#-step-20-bob---alice-commitment_signed">#</a></h3>
<p><img loading="lazy" src="/normalChanOp/29-commit_sign_7.png#center" alt=""  />
</p>
<h3 id="-step-21-alice---bob-revoke_and_ack">⚙️ Step 21: Alice -&gt; Bob: <code>revoke_and_ack</code><a hidden class="anchor" aria-hidden="true" href="#-step-21-alice---bob-revoke_and_ack">#</a></h3>
<p><img loading="lazy" src="/normalChanOp/30-revoke_7.png#center" alt=""  />
</p>
<p>The two valid states now look nice and clean once again:</p>
<p><img loading="lazy" src="/normalChanOp/31-clean_up_7.png#center" alt=""  />
</p>
<h2 id="updating-fees">Updating fees<a hidden class="anchor" aria-hidden="true" href="#updating-fees">#</a></h2>
<p>There is one more <code>update_*</code> message that we need to cover and that is
the <code>update_fee</code> message. This message is used to update the fee-rate that the
peers should use when constructing their commitment transactions. The original
fee-rate is decided in the open-channel flow but if the average mempool fee-rate
increases, the channel funder might decide to update the fee of the commitment
transactions so that they have a better chance of getting confirmed in a timely
manner in a force close situation. It could also be that when the channel was
opened, a very high fee-rate was chosen and perhaps a lower fee-rate would be
desired.</p>
<p>This message follows similar rules to other <code>update_*</code> messages in that it must
also be irrevocably committed before it takes effect. The only other extra rule
that applies to this message is that only the channel funder may send this
message.</p>
<p><img loading="lazy" src="/normalChanOp/update_fee.png#center" alt=""  />
</p>
<p>One thing to note is that with anchor channels, the need to use the <code>update_fee</code>
message is becoming less and less since nodes will be able to use CPFP on the
force-close transaction if required.</p>
<h2 id="message-retransmission">Message Retransmission<a hidden class="anchor" aria-hidden="true" href="#message-retransmission">#</a></h2>
<p>Something that you may have picked up on while walking through the add/remove
HTLC flow is that explicit acknowledgements for the <code>update_*</code> messages is
delayed until the <code>commitment_signed</code>/<code>revoke_and_ack</code> exchange. That is ok
most of the time since we assume that the underlying transport between the two
nodes (see <a href="https://github.com/lightning/bolts/blob/master/08-transport.md">Bolt 8</a>) is ordered and reliable. However, if the connection
needs to be re-established for some reason, there will be doubt regarding
whether our peer has received the last message that we sent. This is where the
<code>channel_reestablish</code> message comes in. Upon reconnection, before continuing with
the normal operation flow, the peers will exchange this message to make sure
they are on the same page and to determine which messages they possibly need to
re-send to their peer.</p>
<p><img loading="lazy" src="/normalChanOp/channel_reestablish.png#center" alt=""  />
</p>
<p>Each peer in the channel has their version of the commitment transaction and the
two commitment transactions can be updated independently meaning that the number
of times that one side’s commitment transaction state has been updated (through
the <code>commitment_signed</code> and <code>revoke_and_ack</code> flow) could be completely different
to that of the other side. The <code>next_commitment_number</code> field in the
<code>channel_reestablish</code> message allows us to communicate with our peer the next
<code>commitment_signed</code> that we expect to receive from them. This way, they will
know if we have perhaps missed a <code>commitment_signed</code> from them that they
previously sent before the disconnection. In other words,
<code>next_commitment_number</code> tells the remote peer what we see our latest committed
state to be. Similarly, <code>next_revocation_number</code> is the commitment number of the
next <code>revoke_and_ack</code> that we expect to receive. In other words, this indicates
to our peer which commitment number we think is their latest one. The
<code>your_last_per_commitment_secret</code> is the last per-commitment secret received
from the remote peer which will give the remote peer an idea of the state it has
definitely revoked. <code>my_current_per_commitment_point</code> is the commitment point of
the local party on its last commitment transaction signed by the remote peer (in
other words, the commitment transaction that has not yet been revoked). There
are a lot of checks that a node should do when receiving a <code>channel_reestablish</code>
in order to make sure that all necessary updates are re-sent so that the channel
can continue as normal. There are also some checks that ensure that nodes are
not tricked into revoking a state that should not yet be revoked or tricked into
broadcasting a state that <em>has</em> been revoked. If you are interested in the
details around these checks, see <a href="https://github.com/lightning/bolts/blob/master/02-peer-protocol.md#message-retransmission">bolt 2</a>.</p>
<p>Note that when a connection re-establish happens, both sides must remove any
un-committed updates from their staging area. If we stick with the git analogy,
they should hit <code>git stash</code> when a reconnection occurs. This means that both
sides will need to re-transmit any <code>update_*</code> messages that were not yet
committed on the other side’s commitment transaction.</p>
<h1 id="closing-a-channel-cooperatively">Closing a channel cooperatively<a hidden class="anchor" aria-hidden="true" href="#closing-a-channel-cooperatively">#</a></h1>
<p>Alice and Bob sure had some good times together but all good things must come to
an end. Closing a channel in a cooperative way requires the two peers to decide
on a final closing transaction that will spend from the funding transaction and
will pay each of them their final channel balance immediately.</p>
<h3 id="-step-22-bob---alice-shutdown">⚙️ Step 22: Bob -&gt; Alice: <code>shutdown</code><a hidden class="anchor" aria-hidden="true" href="#-step-22-bob---alice-shutdown">#</a></h3>
<p>Bob has decided that it is time to cut ties and sends Alice the <code>shutdown</code>
message.</p>
<p><img loading="lazy" src="/normalChanOp/shutdown.png#center" alt=""  />
</p>
<p>The <code>shutdown</code> message contains the <code>scriptpubkey</code> that Bob would like his final
channel balance to be sent to in the closing transaction. Once Bob has sent this
message, he may no longer send any new <code>update_add_htlc</code> messages. He may only
send HTLC removal and <code>update_fee</code> messages. When Alice receives this message
from Bob, she must respond with her own <code>shutdown</code> message and may also no
longer send any new <code>update_add_htlc</code> messages. Alice and Bob now need to wait
until all remaining HTLCs have been cleared from both commitment transactions.
Since the closing transaction will spend from the funding transaction and
explicitly looks different from the commitment transactions, I’ll re-introduce
some of the details in to the state diagram:</p>
<p><img loading="lazy" src="/normalChanOp/1-initial.png#center" alt=""  />
</p>
<p>Once all the HTLCs have been cleared, which in our example is already the case,
they can start negotiating a fee to use for the final closing transaction. The
funder of the channel must start this negotiation. Let’s assume that the funder
of this channel was Alice.</p>
<h3 id="-step-23-alice---bob-closing_signed">⚙️ Step 23: Alice -&gt; Bob: <code>closing_signed</code><a hidden class="anchor" aria-hidden="true" href="#-step-23-alice---bob-closing_signed">#</a></h3>
<p>Alice will first choose a fee-rate that she thinks is appropriate for the
closing transaction. She will then use that fee-rate to complete the
construction of the closing transaction and will sign it. She then sends the
<code>closing_signed</code> message to Bob:</p>
<p><img loading="lazy" src="/normalChanOp/closing_signed.png#center" alt=""  />
</p>
<p>The <code>fee_satoshis</code> field tells Bob the fee in satoshis that Alice used to
construct the first closing transaction proposal and the <code>signature</code> contains
Alice’s signature for this proposal. She may optionally also include the
<code>min_fee_satoshis</code> and <code>max_fee_satoshis</code> fields in order to let Bob know that
if he disagrees with her proposed <code>fee_satoshis</code>, then he may send a
counterproposal as long as his counterproposal lies between the provided
minimum and maximum values.</p>
<p>At this point, the channel state looks as follows:</p>
<p><img loading="lazy" src="/normalChanOp/32-closing-alice-prop.png#center" alt=""  />
</p>
<p>There are two valid commitment transactions that can be signed at any time by
each party to perform a force close, and there is one closing transaction
proposal that uses a fee-rate of <code>x</code> sats-per-byte. This closing transaction
currently only has Alice’s signature and so is not yet valid.</p>
<p>If at this point, Bob is happy with Alice&rsquo;s proposal, he could go ahead and
sign the closing transaction using the fee-rate proposed by Alice and could
broadcast it and that would be the end of it. But for the sake of the example,
let&rsquo;s say that Bob isn&rsquo;t quite happy yet.</p>
<h3 id="-step-24-bob---alice-closing_signed">⚙️ Step 24: Bob -&gt; Alice: <code>closing_signed</code><a hidden class="anchor" aria-hidden="true" href="#-step-24-bob---alice-closing_signed">#</a></h3>
<p>Bob may decide that the fee rate that Alice used is too low. So he sends a
counterproposal with a new fee rate, <code>y</code> sats-per-byte, along with his
signature for this counterproposal.</p>
<p><img loading="lazy" src="/normalChanOp/33-closing-bob-prop.png#center" alt=""  />
</p>
<h3 id="-step-25-alice---bob-closing_signed">⚙️ Step 25: Alice -&gt; Bob: <code>closing_signed</code><a hidden class="anchor" aria-hidden="true" href="#-step-25-alice---bob-closing_signed">#</a></h3>
<p>If Alice is happy with Bob’s counterproposal, then she signs the closing
transaction using the fee-rate suggested by Bob. She may then broadcast the
transaction and call it a day. However, it is recommended in the spec that
Alice send one more <code>closing_signed</code> message to Bob but this time with the
<code>fee_satoshis</code> field set to <code>y</code> sats-per-byte along with her signature for the
transaction. Both parties will now have both signature required in order to
broadcast the final closing transaction that uses the <code>y</code> sats-per-byte fee rate.</p>
<p><img loading="lazy" src="/normalChanOp/34-closing-alice-agree.png#center" alt=""  />
</p>
<p>Either or both parties may now broadcast the closing transaction to the Bitcoin
network. Eventually it will be confirmed, and the channel will officially be
closed.</p>
<p><img loading="lazy" src="/normalChanOp/35-closed.png#center" alt=""  />
</p>
<p>If this channel was a public channel, then any node in the network that had this
channel in their routing graph will be able to see that the channel’s funding
output has been spent and so will remove the channel from their graph at this
point.</p>
<p>The beauty of the channel is that Alice and Bob could have sent millions of
HTLCs back and forth throughout the lifetime of the channel and in the end, all
that showed up on-chain was the opening and closing transaction.</p>
<p>Alice and Bob lived happily ever after.</p>
<p>Thanks for reading! As always, if anything is unclear or incorrect, feel free
to leave a comment down below.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>

<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share Normal operation and closure of a pre-taproot LN channel on twitter"
        href="https://twitter.com/intent/tweet/?text=Normal%20operation%20and%20closure%20of%20a%20pre-taproot%20LN%20channel&amp;url=https%3a%2f%2fwww.ellemouton.com%2fposts%2fnormal-operation-pre-taproot%2f&amp;hashtags=">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-253.927,424.544c135.939,0 210.268,-112.643 210.268,-210.268c0,-3.218 0,-6.437 -0.153,-9.502c14.406,-10.421 26.973,-23.448 36.935,-38.314c-13.18,5.824 -27.433,9.809 -42.452,11.648c15.326,-9.196 26.973,-23.602 32.49,-40.92c-14.252,8.429 -30.038,14.56 -46.896,17.931c-13.487,-14.406 -32.644,-23.295 -53.946,-23.295c-40.767,0 -73.87,33.104 -73.87,73.87c0,5.824 0.613,11.494 1.992,16.858c-61.456,-3.065 -115.862,-32.49 -152.337,-77.241c-6.284,10.881 -9.962,23.601 -9.962,37.088c0,25.594 13.027,48.276 32.95,61.456c-12.107,-0.307 -23.448,-3.678 -33.41,-9.196l0,0.92c0,35.862 25.441,65.594 59.311,72.49c-6.13,1.686 -12.72,2.606 -19.464,2.606c-4.751,0 -9.348,-0.46 -13.946,-1.38c9.349,29.426 36.628,50.728 68.965,51.341c-25.287,19.771 -57.164,31.571 -91.8,31.571c-5.977,0 -11.801,-0.306 -17.625,-1.073c32.337,21.15 71.264,33.41 112.95,33.41Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Normal operation and closure of a pre-taproot LN channel on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwww.ellemouton.com%2fposts%2fnormal-operation-pre-taproot%2f&amp;title=Normal%20operation%20and%20closure%20of%20a%20pre-taproot%20LN%20channel&amp;summary=Normal%20operation%20and%20closure%20of%20a%20pre-taproot%20LN%20channel&amp;source=https%3a%2f%2fwww.ellemouton.com%2fposts%2fnormal-operation-pre-taproot%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Normal operation and closure of a pre-taproot LN channel on reddit"
        href="https://reddit.com/submit?url=https%3a%2f%2fwww.ellemouton.com%2fposts%2fnormal-operation-pre-taproot%2f&title=Normal%20operation%20and%20closure%20of%20a%20pre-taproot%20LN%20channel">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Normal operation and closure of a pre-taproot LN channel on facebook"
        href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.ellemouton.com%2fposts%2fnormal-operation-pre-taproot%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Normal operation and closure of a pre-taproot LN channel on whatsapp"
        href="https://api.whatsapp.com/send?text=Normal%20operation%20and%20closure%20of%20a%20pre-taproot%20LN%20channel%20-%20https%3a%2f%2fwww.ellemouton.com%2fposts%2fnormal-operation-pre-taproot%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Normal operation and closure of a pre-taproot LN channel on telegram"
        href="https://telegram.me/share/url?text=Normal%20operation%20and%20closure%20of%20a%20pre-taproot%20LN%20channel&amp;url=https%3a%2f%2fwww.ellemouton.com%2fposts%2fnormal-operation-pre-taproot%2f">
        <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
            <path
                d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
        </svg>
    </a>
</div>
  </footer><script src="https://utteranc.es/client.js"
        repo="ellemouton/website"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</article>
</main>

<footer class="footer">
    <span>&copy; 2024 <a href="https://www.ellemouton.com">Elle Mouton</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
